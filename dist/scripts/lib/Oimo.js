var OIMO={REVISION:"DEV.1.1.2a"};OIMO.SHAPE_SPHERE=1,OIMO.SHAPE_BOX=2,OIMO.WORLD_SCALE=1,OIMO.INV_SCALE=1,OIMO.TO_RAD=Math.PI/180,OIMO.TwoPI=2*Math.PI,OIMO.nextID=0;var OIMO_ARRAY_TYPE;OIMO_ARRAY_TYPE||(OIMO_ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array),OIMO.World=function(i,t,s,h){this.timeStep=i||1/60,this.numIterations=s||8;var e=t||2;switch(e){case 1:this.broadPhase=new OIMO.BruteForceBroadPhase;break;case 2:default:this.broadPhase=new OIMO.SAPBroadPhase;break;case 3:this.broadPhase=new OIMO.DBVTBroadPhase}this.enableRandomizer=!0,this.isNoStat=h||!1,this.rigidBodies=null,this.numRigidBodies=0,this.contacts=null,this.unusedContacts=null,this.numContacts=0,this.numContactPoints=0,this.joints=null,this.numJoints=0,this.numIslands=0,this.gravity=new OIMO.Vec3(0,-9.80665,0),this.performance=null,this.isNoStat||(this.performance=new OIMO.Performance(this));var a=3;this.detectors=[],this.detectors.length=a;for(var o=a;o--;)this.detectors[o]=[],this.detectors[o].length=a;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_SPHERE]=new OIMO.SphereSphereCollisionDetector,this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_BOX]=new OIMO.SphereBoxCollisionDetector(!1),this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_SPHERE]=new OIMO.SphereBoxCollisionDetector(!0),this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_BOX]=new OIMO.BoxBoxCollisionDetector,this.randX=65535,this.randA=98765,this.randB=123456789,this.maxIslandRigidBodies=64,this.islandRigidBodies=[],this.islandRigidBodies.length=this.maxIslandRigidBodies,this.islandStack=[],this.islandStack.length=this.maxIslandRigidBodies,this.maxIslandConstraints=128,this.islandConstraints=[],this.islandConstraints.length=this.maxIslandConstraints},OIMO.World.prototype={constructor:OIMO.World,clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies);OIMO.nextID=0},addRigidBody:function(i){if(i.parent)throw new Error("It is not possible to be added to more than one world one of the rigid body");i.parent=this,i.awake();for(var t=i.shapes;null!==t;t=t.next)this.addShape(t);null!==this.rigidBodies&&((this.rigidBodies.prev=i).next=this.rigidBodies),this.rigidBodies=i,this.numRigidBodies++},removeRigidBody:function(i){var t=i;if(t.parent===this){t.awake();for(var s=t.jointLink;null!=s;){var h=s.joint;s=s.next,this.removeJoint(h)}for(var e=i.shapes;null!==e;e=e.next)this.removeShape(e);var a=t.prev,o=t.next;null!==a&&(a.next=o),null!==o&&(o.prev=a),this.rigidBodies==t&&(this.rigidBodies=o),t.prev=null,t.next=null,t.parent=null,this.numRigidBodies--}},getByName:function(i){for(var t=null,s=this.rigidBodies;null!==s;)" "!==s.name&&s.name===i&&(t=s),s=s.next;for(var h=this.joints;null!==h;)""!==h.name&&h.name===i&&(t=h),h=h.next;return t},addShape:function(i){if(!i.parent||!i.parent.parent)throw new Error("It is not possible to be added alone to shape world");i.proxy=this.broadPhase.createProxy(i),i.updateProxy(),this.broadPhase.addProxy(i.proxy)},removeShape:function(i){this.broadPhase.removeProxy(i.proxy),i.proxy=null},addJoint:function(i){if(i.parent)throw new Error("It is not possible to be added to more than one world one of the joint");null!=this.joints&&((this.joints.prev=i).next=this.joints),this.joints=i,i.parent=this,this.numJoints++,i.awake(),i.attach()},removeJoint:function(i){var t=i,s=t.prev,h=t.next;null!==s&&(s.next=h),null!==h&&(h.prev=s),this.joints==t&&(this.joints=h),t.prev=null,t.next=null,this.numJoints--,t.awake(),t.detach(),t.parent=null},worldscale:function(i){OIMO.WORLD_SCALE=i||100,OIMO.INV_SCALE=1/OIMO.WORLD_SCALE},step:function(){var i,t,s,h;this.isNoStat||(i=Date.now());for(var e=this.rigidBodies;null!==e;)e.addedToIsland=!1,e.sleeping&&(e.linearVelocity.testZero()||e.position.testDiff(e.sleepPosition)||e.orientation.testDiff(e.sleepOrientation))&&e.awake(),e=e.next;this.isNoStat||(t=Date.now()),this.broadPhase.detectPairs();for(var a=this.broadPhase.pairs,o=this.broadPhase.numPairs,n=o;n--;){var l,r,m=a[n];m.shape1.id<m.shape2.id?(l=m.shape1,r=m.shape2):(l=m.shape2,r=m.shape1);var c;c=l.numContacts<r.numContacts?l.contactLink:r.contactLink;for(var x=!1;c;){var p=c.contact;if(p.shape1==l&&p.shape2==r){p.persisting=!0,x=!0;break}c=c.next}x||this.addContact(l,r)}for(this.isNoStat||(s=Date.now(),this.performance.broadPhaseTime=s-t),this.numContactPoints=0,p=this.contacts;null!==p;){if(!p.persisting){var u=p.shape1.aabb,y=p.shape2.aabb;if(u.minX>y.maxX||u.maxX<y.minX||u.minY>y.maxY||u.maxY<y.minY||u.minZ>y.maxZ||u.maxZ<y.minZ){var d=p.next;this.removeContact(p),p=d;continue}}var O=p.body1,M=p.body2;(O.isDynamic&&!O.sleeping||M.isDynamic&&!M.sleeping)&&p.updateManifold(),this.numContactPoints+=p.manifold.numPoints,p.persisting=!1,p.constraint.addedToIsland=!1,p=p.next}this.isNoStat||(h=Date.now(),this.performance.narrowPhaseTime=h-s);var I,v,z=1/this.timeStep;for(I=this.joints;null!==I;I=I.next)I.addedToIsland=!1;this.maxIslandRigidBodies<this.numRigidBodies&&(this.maxIslandRigidBodies=this.numRigidBodies<<1,this.islandRigidBodies=[],this.islandStack=[],this.islandRigidBodies.length=this.maxIslandRigidBodies,this.islandStack.length=this.maxIslandRigidBodies);var f=this.numJoints+this.numContacts;this.maxIslandConstraints<f&&(this.maxIslandConstraints=f<<1,this.islandConstraints=[],this.islandConstraints.length=this.maxIslandConstraints),t=Date.now(),this.numIslands=0;for(var b=this.rigidBodies;null!==b;b=b.next)if(!(b.addedToIsland||b.isStatic||b.sleeping))if(b.isLonely())b.isDynamic&&b.linearVelocity.addTime(this.gravity,this.timeStep),this.calSleep(b)?(b.sleepTime+=this.timeStep,b.sleepTime>.5?b.sleep():b.updatePosition(this.timeStep)):(b.sleepTime=0,b.updatePosition(this.timeStep)),this.numIslands++;else{var A=0,k=0,g=1;this.islandStack[0]=b,b.addedToIsland=!0;do if(e=this.islandStack[--g],this.islandStack[g]=null,e.sleeping=!1,this.islandRigidBodies[A++]=e,!e.isStatic){for(var S=e.contactLink;null!==S;S=S.next){var p=S.contact;if(v=p.constraint,!v.addedToIsland&&p.touching){this.islandConstraints[k++]=v,v.addedToIsland=!0;var d=S.body;d.addedToIsland||(this.islandStack[g++]=d,d.addedToIsland=!0)}}for(var w=e.jointLink;null!==w;w=w.next)v=w.joint,v.addedToIsland||(this.islandConstraints[k++]=v,v.addedToIsland=!0,d=w.body,!d.addedToIsland&&d.isDynamic&&(this.islandStack[g++]=d,d.addedToIsland=!0))}while(0!=g);for(var L=(new OIMO.Vec3).addTime(this.gravity,this.timeStep),P=A;P--;)e=this.islandRigidBodies[P],e.isDynamic&&e.linearVelocity.addEqual(L);if(this.enableRandomizer)for(P=k;P--;)if(0!==P){var V=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*P|0;v=this.islandConstraints[P],this.islandConstraints[P]=this.islandConstraints[V],this.islandConstraints[V]=v}for(P=k;P--;)this.islandConstraints[P].preSolve(this.timeStep,z);for(var T=this.numIterations;T--;)for(P=k;P--;)this.islandConstraints[P].solve();for(P=k;P--;)this.islandConstraints[P].postSolve(),this.islandConstraints[P]=null;var Y=10;for(P=A;P--;)e=this.islandRigidBodies[P],this.calSleep(e)?(e.sleepTime+=this.timeStep,e.sleepTime<Y&&(Y=e.sleepTime)):(e.sleepTime=0,Y=0);if(Y>.5)for(P=A;P--;)this.islandRigidBodies[P].sleep(),this.islandRigidBodies[P]=null;else for(P=A;P--;)this.islandRigidBodies[P].updatePosition(this.timeStep),this.islandRigidBodies[P]=null;this.numIslands++}this.isNoStat||(s=Date.now(),this.performance.solvingTime=s-t,s=Date.now(),this.performance.upfps(),this.performance.totalTime=s-i,this.performance.updatingTime=this.performance.totalTime-(this.performance.broadPhaseTime+this.performance.narrowPhaseTime+this.performance.solvingTime))},addContact:function(i,t){var s;null!==this.unusedContacts?(s=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):s=new OIMO.Contact,s.attach(i,t),s.detector=this.detectors[i.type][t.type],this.contacts&&((this.contacts.prev=s).next=this.contacts),this.contacts=s,this.numContacts++},removeContact:function(i){var t=i.prev,s=i.next;s&&(s.prev=t),t&&(t.next=s),this.contacts==i&&(this.contacts=s),i.prev=null,i.next=null,i.detach(),i.next=this.unusedContacts,this.unusedContacts=i,this.numContacts--},checkContact:function(i,t){for(var s,h,e=this.contacts;null!==e;){if(s=e.body1.name||" ",h=e.body2.name||" ",s==i&&h==t||h==i&&s==t)return e.touching?!0:!1;e=e.next}return!1},calSleep:function(i){return i.allowSleep?i.linearVelocity.len()>.04?!1:i.angularVelocity.len()>.25?!1:!0:!1}},OIMO.RigidBody=function(i,t,s,h,e,a,o){var n=h||0,l=e||0,r=a||0,m=o||0,c=i||0,x=t||0,p=s||0;this.name=" ",this.BODY_DYNAMIC=1,this.BODY_STATIC=2,this.MAX_SHAPES=64,this.prev=null,this.next=null,this.type=0,this.massInfo=new OIMO.MassInfo,this.position=new OIMO.Vec3(c,x,p),this.newPosition=new OIMO.Vec3(0,0,0),this.controlPos=!1,this.newOrientation=new OIMO.Quat,this.newRotation=new OIMO.Vec3(0,0,0),this.currentRotation=new OIMO.Vec3(0,0,0),this.controlRot=!1,this.controlRotInTime=!1,this.orientation=this.rotationAxisToQuad(n,l,r,m),this.linearVelocity=new OIMO.Vec3,this.angularVelocity=new OIMO.Vec3,this.matrix=new OIMO.Mat44,this.parent=null,this.contactLink=null,this.numContacts=0,this.shapes=null,this.numShapes=0,this.jointLink=null,this.numJoints=0,this.sleepPosition=new OIMO.Vec3,this.sleepOrientation=new OIMO.Quat,this.isStatic=!1,this.isDynamic=!1,this.rotation=new OIMO.Mat33,this.mass=0/0,this.inverseMass=0/0,this.inverseInertia=new OIMO.Mat33,this.localInertia=new OIMO.Mat33,this.inverseLocalInertia=new OIMO.Mat33,this.addedToIsland=!1,this.allowSleep=!0,this.sleepTime=0,this.sleeping=!1},OIMO.RigidBody.prototype={constructor:OIMO.RigidBody,addShape:function(i){if(i.parent)throw new Error("It is not possible that you add to the multi-rigid body the shape of one");null!=this.shapes&&((this.shapes.prev=i).next=this.shapes),this.shapes=i,i.parent=this,this.parent&&this.parent.addShape(i),this.numShapes++},removeShape:function(i){var t=i;if(t.parent==this){var s=t.prev,h=t.next;null!=s&&(s.next=h),null!=h&&(h.prev=s),this.shapes==t&&(this.shapes=h),t.prev=null,t.next=null,t.parent=null,this.parent&&this.parent.removeShape(t),this.numShapes--}},setupMass:function(i,t){var s=void 0!==t?t:!0,h=i||this.BODY_DYNAMIC;this.type=h,this.isDynamic=h==this.BODY_DYNAMIC,this.isStatic=h==this.BODY_STATIC,this.mass=0,this.localInertia.init(0,0,0,0,0,0,0,0,0);for(var e=this.localInertia.elements,a=new OIMO.Mat33,o=new OIMO.Vec3,n=this.shapes;null!=n;n=n.next){n.calculateMassInfo(this.massInfo);var l=this.massInfo.mass,r=n.relativePosition.x,m=n.relativePosition.y,c=n.relativePosition.z;o.addScale(n.relativePosition,l),this.mass+=l,this.rotateInertia(n.relativeRotation,this.massInfo.inertia,a),this.localInertia.addEqual(a),e[0]+=l*(m*m+c*c),e[4]+=l*(r*r+c*c),e[8]+=l*(r*r+m*m);var x=l*r*m,p=l*m*c,u=l*c*r;e[1]-=x,e[3]-=x,e[2]-=p,e[6]-=p,e[5]-=u,e[7]-=u}if(this.inverseMass=1/this.mass,o.scaleEqual(this.inverseMass),s){for(this.position.addEqual(o),n=this.shapes;null!=n;n=n.next)n.relativePosition.subEqual(o);r=o.x,m=o.y,c=o.z,e[0]-=this.mass*(m*m+c*c),e[4]-=this.mass*(r*r+c*c),e[8]-=this.mass*(r*r+m*m),x=this.mass*r*m,p=this.mass*m*c,u=this.mass*c*r,e[1]+=x,e[3]+=x,e[2]+=p,e[6]+=p,e[5]+=u,e[7]+=u}this.inverseLocalInertia.invert(this.localInertia),h==this.BODY_STATIC&&(this.inverseMass=0,this.inverseLocalInertia.init(0,0,0,0,0,0,0,0,0)),this.syncShapes(),this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1,this.sleepTime=0;for(var i=this.contactLink;null!=i;)i.body.sleepTime=0,i.body.sleeping=!1,i=i.next;for(var t=this.jointLink;null!=t;)t.body.sleepTime=0,t.body.sleeping=!1,t=t.next;for(var s=this.shapes;null!=s;s=s.next)s.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.init(),this.angularVelocity.init(),this.sleepPosition.copy(this.position),this.sleepOrientation.copy(this.orientation),this.sleepTime=0,this.sleeping=!0;for(var i=this.shapes;null!=i;i=i.next)i.updateProxy()}},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(i){switch(this.type){case this.BODY_STATIC:this.linearVelocity.init(),this.angularVelocity.init(),this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1),this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case this.BODY_DYNAMIC:this.controlPos&&(this.angularVelocity.init(),this.linearVelocity.init(),this.linearVelocity.x=(this.newPosition.x-this.position.x)/i,this.linearVelocity.y=(this.newPosition.y-this.position.y)/i,this.linearVelocity.z=(this.newPosition.z-this.position.z)/i,this.controlPos=!1),this.controlRot&&(this.angularVelocity.init(),this.orientation.copy(this.newOrientation),this.controlRot=!1),this.position.addTime(this.linearVelocity,i),this.orientation.addTime(this.angularVelocity,i);break;default:throw new Error("Invalid type.")}this.syncShapes()},rotateInertia:function(i,t,s){var h=i.elements,e=t.elements,a=h[0],o=h[3],n=h[6],l=h[1],r=h[4],m=h[7],c=h[2],x=h[5],p=h[8],u=e[0],y=e[3],d=e[6],O=e[1],M=e[4],I=e[7],v=e[2],z=e[5],f=e[8],b=a*u+l*y+c*d,A=a*O+l*M+c*I,k=a*v+l*z+c*f,g=o*u+r*y+x*d,S=o*O+r*M+x*I,w=o*v+r*z+x*f,L=n*u+m*y+p*d,P=n*O+m*M+p*I,V=n*v+m*z+p*f,T=s.elements;T[0]=b*a+A*l+k*c,T[1]=b*o+A*r+k*x,T[2]=b*n+A*m+k*p,T[3]=g*a+S*l+w*c,T[4]=g*o+S*r+w*x,T[5]=g*n+S*m+w*p,T[6]=L*a+P*l+V*c,T[7]=L*o+P*r+V*x,T[8]=L*n+P*m+V*p},syncShapes:function(){var i=this.orientation.s,t=this.orientation.x,s=this.orientation.y,h=this.orientation.z,e=2*t,a=2*s,o=2*h,n=t*e,l=s*a,r=h*o,m=t*a,c=s*o,x=t*o,p=i*e,u=i*a,y=i*o,d=this.rotation.elements;d[0]=1-l-r,d[1]=m-y,d[2]=x+u,d[3]=m+y,d[4]=1-n-r,d[5]=c-p,d[6]=x-u,d[7]=c+p,d[8]=1-n-l,this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(var O=this.shapes;null!=O;O=O.next)O.position.mul(this.position,O.relativePosition,this.rotation),O.rotation.mul(O.relativeRotation,this.rotation),O.updateProxy()},applyImpulse:function(i,t){this.linearVelocity.addScale(t,this.inverseMass);var s=new OIMO.Vec3;s.sub(i,this.position).cross(s,t).mulMat(this.inverseInertia,s),this.angularVelocity.addEqual(s)},rotationVectToQuad:function(i){var t=OIMO.EulerToAxis(i.x*OIMO.TO_RAD,i.y*OIMO.TO_RAD,i.z*OIMO.TO_RAD);return this.rotationAxisToQuad(t[0],t[1],t[2],t[3])},rotationAxisToQuad:function(i,t,s,h){var e=t*t+s*s+h*h;e>0&&(e=1/Math.sqrt(e),t*=e,s*=e,h*=e);var a=Math.sin(.5*i),o=Math.cos(.5*i);return new OIMO.Quat(o,a*t,a*s,a*h)},setPosition:function(i){this.newPosition.init(i.x*OIMO.INV_SCALE,i.y*OIMO.INV_SCALE,i.z*OIMO.INV_SCALE),this.controlPos=!0},setQuaternion:function(i){this.newOrientation.init(i.w,i.x,i.y,i.z),this.controlRot=!0},setRotation:function(i){this.newOrientation=this.rotationVectToQuad(i),this.controlRot=!0},resetPosition:function(i,t,s){this.linearVelocity.init(),this.angularVelocity.init(),this.position.init(i*OIMO.INV_SCALE,t*OIMO.INV_SCALE,s*OIMO.INV_SCALE),this.awake()},resetQuaternion:function(i){this.angularVelocity.init(),this.orientation=new OIMO.Quat(i.w,i.x,i.y,i.z),this.awake()},resetRotation:function(i,t,s){this.angularVelocity.init(),this.orientation=this.rotationVectToQuad(new OIMO.Vec3(i,t,s)),this.awake()},getPosition:function(){return(new OIMO.Vec3).scale(this.position,OIMO.WORLD_SCALE)},getRotation:function(){return(new OIMO.Euler).setFromRotationMatrix(this.rotation)},getQuaternion:function(){return(new OIMO.Quaternion).setFromRotationMatrix(this.rotation)},getMatrix:function(){var i,t,s=this.matrix.elements;return this.sleeping?s[15]=1:(i=this.rotation.elements,s[0]=i[0],s[1]=i[3],s[2]=i[6],s[3]=0,s[4]=i[1],s[5]=i[4],s[6]=i[7],s[7]=0,s[8]=i[2],s[9]=i[5],s[10]=i[8],s[11]=0,t=this.position,s[12]=t.x*OIMO.WORLD_SCALE,s[13]=t.y*OIMO.WORLD_SCALE,s[14]=t.z*OIMO.WORLD_SCALE,s[15]=0),s}},OIMO.Body=function(i){var t=i||{};if(t.world){this.parent=t.world,this.name=t.name||"";var s=t.move||!1,h=t.noSleep||!1,e=t.pos||[0,0,0];e=e.map(function(i){return i*OIMO.INV_SCALE});var a=t.size||[1,1,1];a=a.map(function(i){return i*OIMO.INV_SCALE});var o=t.rot||[0,0,0];o=o.map(function(i){return i*OIMO.TO_RAD});for(var n=[],l=0;l<o.length/3;l++){var r=OIMO.EulerToAxis(o[l+0],o[l+1],o[l+2]);n.push(r[0]),n.push(r[1]),n.push(r[2]),n.push(r[3])}var m=t.sc||new OIMO.ShapeConfig;t.config&&(m.density=t.config[0]||1,m.friction=t.config[1]||.4,m.restitution=t.config[2]||.2,m.belongsTo=t.config[3]||1,m.collidesWith=t.config[4]||4294967295),t.massPos&&(t.massPos=t.massPos.map(function(i){return i*OIMO.INV_SCALE}),m.relativePosition.init(t.massPos[0],t.massPos[1],t.massPos[2])),t.massRot&&(t.massRot=t.massRot.map(function(i){return i*OIMO.TO_RAD}),m.relativeRotation=OIMO.EulerToMatrix(t.massRot[0],t.massRot[1],t.massRot[2])),this.body=new OIMO.RigidBody(e[0],e[1],e[2],n[0],n[1],n[2],n[3]);var c=[],x=t.type||"box";"string"==typeof x&&(x=[x]);for(var p,u,l=0;l<x.length;l++){switch(p=3*l,u=4*l,x[l]){case"sphere":c[l]=new OIMO.SphereShape(m,a[p+0]);break;case"cylinder":c[l]=new OIMO.BoxShape(m,a[p+0],a[p+1],a[p+2]);break;case"box":c[l]=new OIMO.BoxShape(m,a[p+0],a[p+1],a[p+2])}this.body.addShape(c[l]),l>0&&(c[l].relativePosition=new OIMO.Vec3(e[p+0],e[p+1],e[p+2]),n[u+0]&&(c[l].relativeRotation=[n[u+0],n[u+1],n[u+2],n[u+3]]))}s?(t.massPos||t.massRot?this.body.setupMass(1,!1):this.body.setupMass(1,!0),this.body.allowSleep=h?!1:!0):this.body.setupMass(2),this.body.name=this.name,this.sleeping=this.body.sleeping,this.parent.addRigidBody(this.body)}},OIMO.Body.prototype={constructor:OIMO.Body,setPosition:function(i){this.body.setPosition(i)},setQuaternion:function(i){this.body.setQuaternion(i)},setRotation:function(i){this.body.setRotation(i)},getPosition:function(){return this.body.getPosition()},getRotation:function(){return this.body.getRotation()},getQuaternion:function(){return this.body.getQuaternion()},getMatrix:function(){return this.body.getMatrix()},getSleep:function(){return this.body.sleeping},resetPosition:function(i,t,s){this.body.resetPosition(i,t,s)},resetRotation:function(i,t,s){this.body.resetRotation(i,t,s)},awake:function(){this.body.awake()},remove:function(){this.parent.removeRigidBody(this.body)},checkContact:function(i){this.parent.checkContact(this.name,i)}},OIMO.Link=function(i){var t=i||{};if(t.world){this.parent=t.world,this.name=t.name||"";var s=t.type||"jointHinge",h=t.axe1||[1,0,0],e=t.axe2||[1,0,0],a=t.pos1||[0,0,0],o=t.pos2||[0,0,0];a=a.map(function(i){return i*OIMO.INV_SCALE}),o=o.map(function(i){return i*OIMO.INV_SCALE});var n,l;"jointDistance"===s?(n=t.min||0,l=t.max||10,n*=OIMO.INV_SCALE,l*=OIMO.INV_SCALE):(n=t.min||57.29578,l=t.max||0,n*=OIMO.TO_RAD,l*=OIMO.TO_RAD);var r=t.limit||null,m=t.spring||null,c=t.motor||null,x=new OIMO.JointConfig;switch(x.allowCollision=t.collision||!1,x.localAxis1.init(h[0],h[1],h[2]),x.localAxis2.init(e[0],e[1],e[2]),x.localAnchorPoint1.init(a[0],a[1],a[2]),x.localAnchorPoint2.init(o[0],o[1],o[2]),("string"==typeof t.body1||t.body1 instanceof String)&&(t.body1=t.world.getByName(t.body1)),("string"==typeof t.body2||t.body2 instanceof String)&&(t.body2=t.world.getByName(t.body2)),x.body1=t.body1,x.body2=t.body2,s){case"jointDistance":this.joint=new OIMO.DistanceJoint(x,n,l),null!==m&&this.joint.limitMotor.setSpring(m[0],m[1]),null!==c&&this.joint.limitMotor.setSpring(c[0],c[1]);break;case"jointHinge":this.joint=new OIMO.HingeJoint(x,n,l),null!==m&&this.joint.limitMotor.setSpring(m[0],m[1]),null!==c&&this.joint.limitMotor.setSpring(c[0],c[1]);break;case"jointPrisme":this.joint=new OIMO.PrismaticJoint(x,n,l);break;case"jointSlide":this.joint=new OIMO.SliderJoint(x,n,l);break;case"jointBall":this.joint=new OIMO.BallAndSocketJoint(x);break;case"jointWheel":this.joint=new OIMO.WheelJoint(x),null!==r&&this.joint.rotationalLimitMotor1.setLimit(r[0],r[1]),null!==m&&this.joint.rotationalLimitMotor1.setSpring(m[0],m[1]),null!==c&&this.joint.rotationalLimitMotor1.setSpring(c[0],c[1])}this.joint.name=this.name,this.parent.addJoint(this.joint)}},OIMO.Link.prototype={constructor:OIMO.Link,getPosition:function(){return this.joint.getPosition()},getMatrix:function(){return this.joint.getMatrix()},remove:function(){this.parent.removeJoint(this.joint)},awake:function(){this.joint.awake()}},OIMO.Performance=function(i){this.parent=i,this.infos=new OIMO_ARRAY_TYPE(13),this.f=[0,0,0],this.fps=0,this.broadPhaseTime=0,this.narrowPhaseTime=0,this.solvingTime=0,this.updatingTime=0,this.totalTime=0},OIMO.Performance.prototype={upfps:function(){this.f[1]=Date.now(),this.f[1]-1e3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0),this.f[2]++},show:function(){var i=["Oimo.js DEV.1.1.2a<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","contact &nbsp;&nbsp;"+this.parent.numContactPoints+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in ms <br>","broad-phase &nbsp;"+this.broadPhaseTime+"<br>","narrow-phase "+this.narrowPhaseTime+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+this.solvingTime+"<br>","updating &nbsp;&nbsp;&nbsp;&nbsp;"+this.updatingTime+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+this.totalTime].join("\n");return i},toArray:function(){return this.infos[0]=this.parent.broadPhase.types,this.infos[1]=this.parent.numRigidBodies,this.infos[2]=this.parent.numContacts,this.infos[3]=this.parent.broadPhase.numPairChecks,this.infos[4]=this.parent.numContactPoints,this.infos[5]=this.parent.numIslands,this.infos[6]=this.broadPhaseTime,this.infos[7]=this.narrowPhaseTime,this.infos[8]=this.solvingTime,this.infos[9]=this.updatingTime,this.infos[10]=this.totalTime,this.infos[11]=this.fps,this.infos}},OIMO.Mat44=function(i,t,s,h,e,a,o,n,l,r,m,c,x,p,u,y){this.elements=new OIMO_ARRAY_TYPE(16);var d=this.elements;d[0]=void 0!==i?i:1,d[4]=t||0,d[8]=s||0,d[12]=h||0,d[1]=e||0,d[5]=void 0!==a?a:1,d[9]=o||0,d[13]=n||0,d[2]=l||0,d[6]=r||0,d[10]=void 0!==m?m:1,d[14]=c||0,d[3]=x||0,d[7]=p||0,d[11]=u||0,d[15]=void 0!==y?y:1},OIMO.Mat44.prototype={constructor:OIMO.Mat44,set:function(i,t,s,h,e,a,o,n,l,r,m,c,x,p,u,y){var d=this.elements;return d[0]=i,d[4]=t,d[8]=s,d[12]=h,d[1]=e,d[5]=a,d[9]=o,d[13]=n,d[2]=l,d[6]=r,d[10]=m,d[14]=c,d[3]=x,d[7]=p,d[11]=u,d[15]=y,this}},OIMO.Mat33=function(i,t,s,h,e,a,o,n,l){this.elements=new OIMO_ARRAY_TYPE(9);this.elements;this.init(void 0!==i?i:1,t||0,s||0,h||0,void 0!==e?e:1,a||0,o||0,n||0,void 0!==l?l:1)},OIMO.Mat33.prototype={constructor:OIMO.Mat33,init:function(i,t,s,h,e,a,o,n,l){var r=this.elements;return r[0]=i,r[1]=t,r[2]=s,r[3]=h,r[4]=e,r[5]=a,r[6]=o,r[7]=n,r[8]=l,this},add:function(i,t){var s=this.elements,h=i.elements,e=t.elements;return s[0]=h[0]+e[0],s[1]=h[1]+e[1],s[2]=h[2]+e[2],s[3]=h[3]+e[3],s[4]=h[4]+e[4],s[5]=h[5]+e[5],s[6]=h[6]+e[6],s[7]=h[7]+e[7],s[8]=h[8]+e[8],this},addEqual:function(i){var t=this.elements,s=i.elements;return t[0]+=s[0],t[1]+=s[1],t[2]+=s[2],t[3]+=s[3],t[4]+=s[4],t[5]+=s[5],t[6]+=s[6],t[7]+=s[7],t[8]+=s[8],this},sub:function(i,t){var s=this.elements,h=i.elements,e=t.elements;return s[0]=h[0]-e[0],s[1]=h[1]-e[1],s[2]=h[2]-e[2],s[3]=h[3]-e[3],s[4]=h[4]-e[4],s[5]=h[5]-e[5],s[6]=h[6]-e[6],s[7]=h[7]-e[7],s[8]=h[8]-e[8],this},subEqual:function(i){var t=this.elements,s=i.elements;return t[0]-=s[0],t[1]-=s[1],t[2]-=s[2],t[3]-=s[3],t[4]-=s[4],t[5]-=s[5],t[6]-=s[6],t[7]-=s[7],t[8]-=s[8],this},scale:function(i,t){var s=this.elements,h=i.elements;return s[0]=h[0]*t,s[1]=h[1]*t,s[2]=h[2]*t,s[3]=h[3]*t,s[4]=h[4]*t,s[5]=h[5]*t,s[6]=h[6]*t,s[7]=h[7]*t,s[8]=h[8]*t,this},scaleEqual:function(i){var t=this.elements;return t[0]*=i,t[1]*=i,t[2]*=i,t[3]*=i,t[4]*=i,t[5]*=i,t[6]*=i,t[7]*=i,t[8]*=i,this},mul:function(i,t){var s=this.elements,h=i.elements,e=t.elements,a=h[0],o=h[3],n=h[6],l=h[1],r=h[4],m=h[7],c=h[2],x=h[5],p=h[8],u=e[0],y=e[3],d=e[6],O=e[1],M=e[4],I=e[7],v=e[2],z=e[5],f=e[8];return s[0]=a*u+l*y+c*d,s[1]=a*O+l*M+c*I,s[2]=a*v+l*z+c*f,s[3]=o*u+r*y+x*d,s[4]=o*O+r*M+x*I,s[5]=o*v+r*z+x*f,s[6]=n*u+m*y+p*d,s[7]=n*O+m*M+p*I,s[8]=n*v+m*z+p*f,this},mulScale:function(i,t,s,h,e){var a=e||!1,o=this.elements,n=i.elements;return a?(o[0]=t*n[0],o[1]=t*n[1],o[2]=t*n[2],o[3]=s*n[3],o[4]=s*n[4],o[5]=s*n[5],o[6]=h*n[6],o[7]=h*n[7],o[8]=h*n[8]):(o[0]=n[0]*t,o[1]=n[1]*s,o[2]=n[2]*h,o[3]=n[3]*t,o[4]=n[4]*s,o[5]=n[5]*h,o[6]=n[6]*t,o[7]=n[7]*s,o[8]=n[8]*h),this},mulRotate:function(i,t,s,h,e,a){var o=a||!1,n=Math.sin(t),l=Math.cos(t),r=1-l,m=s*s*r+l,c=s*h*r-e*n,x=s*e*r+h*n,p=h*s*r+e*n,u=h*h*r+l,y=h*e*r-s*n,d=e*s*r-h*n,O=e*h*r+s*n,M=e*e*r+l,I=i.elements,v=I[0],z=I[3],f=I[6],b=I[1],A=I[4],k=I[7],g=I[2],S=I[5],w=I[8],L=this.elements;return o?(L[0]=m*v+c*z+x*f,L[1]=m*b+c*A+x*k,L[2]=m*g+c*S+x*w,L[3]=p*v+u*z+y*f,L[4]=p*b+u*A+y*k,L[5]=p*g+u*S+y*w,L[6]=d*v+O*z+M*f,L[7]=d*b+O*A+M*k,L[8]=d*g+O*S+M*w):(L[0]=v*m+b*p+g*d,L[1]=v*c+b*u+g*O,L[2]=v*x+b*y+g*M,L[3]=z*m+A*p+S*d,L[4]=z*c+A*u+S*O,L[5]=z*x+A*y+S*M,L[6]=f*m+k*p+w*d,L[7]=f*c+k*u+w*O,L[8]=f*x+k*y+w*M),this},transpose:function(i){var t=this.elements,s=i.elements;return t[0]=s[0],t[1]=s[3],t[2]=s[6],t[3]=s[1],t[4]=s[4],t[5]=s[7],t[6]=s[2],t[7]=s[5],t[8]=s[8],this},setQuat:function(i){var t=this.elements,s=2*i.x,h=2*i.y,e=2*i.z,a=i.x*s,o=i.y*h,n=i.z*e,l=i.x*h,r=i.y*e,m=i.x*e,c=i.s*s,x=i.s*h,p=i.s*e;return t[0]=1-o-n,t[1]=l-p,t[2]=m+x,t[3]=l+p,t[4]=1-a-n,t[5]=r-c,t[6]=m-x,t[7]=r+c,t[8]=1-a-o,this},invert:function(i){var t=this.elements,s=i.elements,h=s[0],e=s[3],a=s[6],o=s[1],n=s[4],l=s[7],r=s[2],m=s[5],c=s[8],x=n*c-l*m,p=l*r-o*c,u=o*m-n*r,y=h*x+e*p+a*u;return 0!=y&&(y=1/y),t[0]=y*x,t[1]=y*p,t[2]=y*u,t[3]=y*(m*a-e*c),t[4]=y*(h*c-r*a),t[5]=y*(r*e-h*m),t[6]=y*(e*l-n*a),t[7]=y*(o*a-h*l),t[8]=y*(h*n-o*e),this},copy:function(i){var t=this.elements,s=i.elements;return t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3],t[4]=s[4],t[5]=s[5],t[6]=s[6],t[7]=s[7],t[8]=s[8],this},toEuler:function(){function i(i){return Math.min(Math.max(i,-1),1)}{var t=this.elements,s=t[0],h=t[3],e=t[6],a=(t[1],t[4]),o=t[7],n=(t[2],t[5]),l=t[8],r=new OIMO.Vec3;new OIMO.Quat}return r.y=Math.asin(i(e)),Math.abs(e)<.99999?(r.x=Math.atan2(-o,l),r.z=Math.atan2(-h,s)):(r.x=Math.atan2(n,a),r.z=0),r},clone:function(){var i=this.elements;return new OIMO.Mat33(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8])},toString:function(){var i=this.elements,t="Mat33|"+i[0].toFixed(4)+", "+i[1].toFixed(4)+", "+i[2].toFixed(4)+"|\n     |"+i[3].toFixed(4)+", "+i[4].toFixed(4)+", "+i[5].toFixed(4)+"|\n     |"+i[6].toFixed(4)+", "+i[7].toFixed(4)+", "+i[8].toFixed(4)+"|";return t}},OIMO.Quat=function(i,t,s,h){this.s=void 0!==i?i:1,this.x=t||0,this.y=s||0,this.z=h||0},OIMO.Quat.prototype={constructor:OIMO.Quat,init:function(i,t,s,h){return this.s=void 0!==i?i:1,this.x=t||0,this.y=s||0,this.z=h||0,this},add:function(i,t){return this.s=i.s+t.s,this.x=i.x+t.x,this.y=i.y+t.y,this.z=i.z+t.z,this},addTime:function(i,t){var s=i.x,h=i.y,e=i.z,a=this.s,o=this.x,n=this.y,l=this.z;t*=.5;var r=(-s*o-h*n-e*l)*t,m=(s*a+h*l-e*n)*t,c=(-s*l+h*a+e*o)*t,x=(s*n-h*o+e*a)*t;a+=r,o+=m,n+=c,l+=x;var p=1/Math.sqrt(a*a+o*o+n*n+l*l);return this.s=a*p,this.x=o*p,this.y=n*p,this.z=l*p,this},sub:function(i,t){return this.s=i.s-t.s,this.x=i.x-t.x,this.y=i.y-t.y,this.z=i.z-t.z,this},scale:function(i,t){return this.s=i.s*t,this.x=i.x*t,this.y=i.y*t,this.z=i.z*t,this},mul:function(i,t){var s=i.x,h=i.y,e=i.z,a=i.s,o=t.x,n=t.y,l=t.z,r=t.s;return this.x=s*r+a*o+h*l-e*n,this.y=h*r+a*n+e*o-s*l,this.z=e*r+a*l+s*n-h*o,this.s=a*r-s*o-h*n-e*l,this},arc:function(i,t){var s=i.x,h=i.y,e=i.z,a=t.x,o=t.y,n=t.z,l=s*a+h*o+e*n;if(-1==l)return a=h*s-e*e,o=-e*h-s*s,n=s*e+h*h,l=1/Math.sqrt(a*a+o*o+n*n),this.s=0,this.x=a*l,this.y=o*l,this.z=n*l,this;var r=h*n-e*o,m=e*a-s*n,c=s*o-h*a;return this.s=Math.sqrt(.5*(1+l)),l=.5/this.s,this.x=r*l,this.y=m*l,this.z=c*l,this},normalize:function(i){var t=Math.sqrt(i.s*i.s+i.x*i.x+i.y*i.y+i.z*i.z);return t>0&&(t=1/t),this.s=i.s*t,this.x=i.x*t,this.y=i.y*t,this.z=i.z*t,this},invert:function(i){return this.s=i.s,this.x=-i.x,this.y=-i.y,this.z=-i.z,this},length:function(){return Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(i){return this.s=i.s,this.x=i.x,this.y=i.y,this.z=i.z,this},testDiff:function(i){return this.s!==i.s||this.x!==i.x||this.y!==i.y||this.z!==i.z?!0:!1},clone:function(){return new OIMO.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}},OIMO.Quaternion=function(i,t,s,h){this.x=i||0,this.y=t||0,this.z=s||0,this.w=void 0!==h?h:1},OIMO.Quaternion.prototype={constructor:OIMO.Quaternion,setFromRotationMatrix:function(i){var t,s=i.elements,h=s[0],e=s[1],a=s[2],o=s[3],n=s[4],l=s[5],r=s[6],m=s[7],c=s[8],x=h+n+c;return x>0?(t=.5/Math.sqrt(x+1),this.w=.25/t,this.x=(m-l)*t,this.y=(a-r)*t,this.z=(o-e)*t):h>n&&h>c?(t=2*Math.sqrt(1+h-n-c),this.w=(m-l)/t,this.x=.25*t,this.y=(e+o)/t,this.z=(a+r)/t):n>c?(t=2*Math.sqrt(1+n-h-c),this.w=(a-r)/t,this.x=(e+o)/t,this.y=.25*t,this.z=(l+m)/t):(t=2*Math.sqrt(1+c-h-n),this.w=(o-e)/t,this.x=(a+r)/t,this.y=(l+m)/t,this.z=.25*t),this}},OIMO.Vec3=function(i,t,s){this.x=i||0,this.y=t||0,this.z=s||0},OIMO.Vec3.prototype={constructor:OIMO.Vec3,init:function(i,t,s){return this.x=i||0,this.y=t||0,this.z=s||0,this},set:function(i,t,s){return this.x=i,this.y=t,this.z=s,this},add:function(i,t){return this.x=i.x+t.x,this.y=i.y+t.y,this.z=i.z+t.z,this},addEqual:function(i){return this.x+=i.x,this.y+=i.y,this.z+=i.z,this},addTime:function(i,t){return this.x+=i.x*t,this.y+=i.y*t,this.z+=i.z*t,this},sub:function(i,t){return this.x=i.x-t.x,this.y=i.y-t.y,this.z=i.z-t.z,this},subEqual:function(i){return this.x-=i.x,this.y-=i.y,this.z-=i.z,this},addScale:function(i,t){return this.x+=i.x*t,this.y+=i.y*t,this.z+=i.z*t,this},scale:function(i,t){return this.x=i.x*t,this.y=i.y*t,this.z=i.z*t,this},scaleEqual:function(i){return this.x*=i,this.y*=i,this.z*=i,this},dot:function(i){return this.x*i.x+this.y*i.y+this.z*i.z},cross:function(i,t){var s=i.x,h=i.y,e=i.z,a=t.x,o=t.y,n=t.z;return this.x=h*n-e*o,this.y=e*a-s*n,this.z=s*o-h*a,this},mul:function(i,t,s){var h=s.elements;return this.x=i.x+t.x*h[0]+t.y*h[1]+t.z*h[2],this.y=i.y+t.x*h[3]+t.y*h[4]+t.z*h[5],this.z=i.z+t.x*h[6]+t.y*h[7]+t.z*h[8],this},mulMat:function(i,t){var s=i.elements,h=s[0]*t.x+s[1]*t.y+s[2]*t.z,e=s[3]*t.x+s[4]*t.y+s[5]*t.z,a=s[6]*t.x+s[7]*t.y+s[8]*t.z;return this.x=h,this.y=e,this.z=a,this},normalize:function(i){var t=i.x,s=i.y,h=i.z,e=t*t+s*s+h*h;return e>0&&(e=1/Math.sqrt(e),this.x=t*e,this.y=s*e,this.z=h*e),this},invert:function(i){return this.x=-i.x,this.y=-i.y,this.z=-i.z,this},length:function(){var i=this.x,t=this.y,s=this.z;return Math.sqrt(i*i+t*t+s*s)},len:function(){var i=this.x,t=this.y,s=this.z;return i*i+t*t+s*s},copy:function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this},applyQuaternion:function(i){var t=this.x,s=this.y,h=this.z,e=i.x,a=i.y,o=i.z,n=i.s,l=n*t+a*h-o*s,r=n*s+o*t-e*h,m=n*h+e*s-a*t,c=-e*t-a*s-o*h;return this.x=l*n+c*-e+r*-o-m*-a,this.y=r*n+c*-a+m*-e-l*-o,this.z=m*n+c*-o+l*-a-r*-e,this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z?!0:!1},testDiff:function(i){return this.x!==i.x||this.y!==i.y||this.z!==i.z?!0:!1},clone:function(){return new OIMO.Vec3(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"}},OIMO.Euler=function(i,t,s,h){this._x=i||0,this._y=t||0,this._z=s||0,this._order=h||OIMO.Euler.DefaultOrder},OIMO.Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],OIMO.Euler.DefaultOrder="XYZ",OIMO.clamp=function(i,t,s){return t>i?t:i>s?s:i},OIMO.Euler.prototype={constructor:OIMO.Euler,_x:0,_y:0,_z:0,_order:OIMO.Euler.DefaultOrder,get x(){return this._x},set x(i){this._x=i,this.onChangeCallback()},get y(){return this._y},set y(i){this._y=i,this.onChangeCallback()},get z(){return this._z},set z(i){this._z=i,this.onChangeCallback()},get order(){return this._order},set order(i){this._order=i,this.onChangeCallback()},set:function(i,t,s,h){return this._x=i,this._y=t,this._z=s,this._order=h||this._order,this.onChangeCallback(),this
},copy:function(i){return this._x=i._x,this._y=i._y,this._z=i._z,this._order=i._order,this.onChangeCallback(),this},setFromRotationMatrix:function(i,t){var s=OIMO.clamp,h=i.elements,e=h[0],a=h[1],o=h[2],n=h[3],l=h[4],r=h[5],m=h[6],c=h[7],x=h[8];return t=t||this._order,"XYZ"===t?(this._y=Math.asin(s(o,-1,1)),Math.abs(o)<.99999?(this._x=Math.atan2(-r,x),this._z=Math.atan2(-a,e)):(this._x=Math.atan2(c,l),this._z=0)):"YXZ"===t?(this._x=Math.asin(-s(r,-1,1)),Math.abs(r)<.99999?(this._y=Math.atan2(o,x),this._z=Math.atan2(n,l)):(this._y=Math.atan2(-m,e),this._z=0)):"ZXY"===t?(this._x=Math.asin(s(c,-1,1)),Math.abs(c)<.99999?(this._y=Math.atan2(-m,x),this._z=Math.atan2(-a,l)):(this._y=0,this._z=Math.atan2(n,e))):"ZYX"===t?(this._y=Math.asin(-s(m,-1,1)),Math.abs(m)<.99999?(this._x=Math.atan2(c,x),this._z=Math.atan2(n,e)):(this._x=0,this._z=Math.atan2(-a,l))):"YZX"===t?(this._z=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(this._x=Math.atan2(-r,l),this._y=Math.atan2(-m,e)):(this._x=0,this._y=Math.atan2(o,x))):"XZY"===t?(this._z=Math.asin(-s(a,-1,1)),Math.abs(a)<.99999?(this._x=Math.atan2(c,l),this._y=Math.atan2(o,e)):(this._x=Math.atan2(-r,x),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,this.onChangeCallback(),this},setFromQuaternion:function(i,t,s){var h=OIMO.clamp,e=i.x*i.x,a=i.y*i.y,o=i.z*i.z,n=i.s*i.s;return t=t||this._order,"XYZ"===t?(this._x=Math.atan2(2*(i.x*i.s-i.y*i.z),n-e-a+o),this._y=Math.asin(h(2*(i.x*i.z+i.y*i.s),-1,1)),this._z=Math.atan2(2*(i.z*i.s-i.x*i.y),n+e-a-o)):"YXZ"===t?(this._x=Math.asin(h(2*(i.x*i.s-i.y*i.z),-1,1)),this._y=Math.atan2(2*(i.x*i.z+i.y*i.s),n-e-a+o),this._z=Math.atan2(2*(i.x*i.y+i.z*i.s),n-e+a-o)):"ZXY"===t?(this._x=Math.asin(h(2*(i.x*i.s+i.y*i.z),-1,1)),this._y=Math.atan2(2*(i.y*i.s-i.z*i.x),n-e-a+o),this._z=Math.atan2(2*(i.z*i.s-i.x*i.y),n-e+a-o)):"ZYX"===t?(this._x=Math.atan2(2*(i.x*i.s+i.z*i.y),n-e-a+o),this._y=Math.asin(h(2*(i.y*i.s-i.x*i.z),-1,1)),this._z=Math.atan2(2*(i.x*i.y+i.z*i.s),n+e-a-o)):"YZX"===t?(this._x=Math.atan2(2*(i.x*i.s-i.z*i.y),n-e+a-o),this._y=Math.atan2(2*(i.y*i.s-i.x*i.z),n+e-a-o),this._z=Math.asin(h(2*(i.x*i.y+i.z*i.s),-1,1))):"XZY"===t?(this._x=Math.atan2(2*(i.x*i.s+i.y*i.z),n-e+a-o),this._y=Math.atan2(2*(i.x*i.z+i.y*i.s),n+e-a-o),this._z=Math.asin(h(2*(i.z*i.s-i.x*i.y),-1,1))):console.warn("OIMO.Euler: .setFromQuaternion() given unsupported order: "+t),this._order=t,s!==!1&&this.onChangeCallback(),this},reorder:function(){var i=new OIMO.Quat;return function(t){i.setFromEuler(this),this.setFromQuaternion(i,t)}}(),equals:function(i){return i._x===this._x&&i._y===this._y&&i._z===this._z&&i._order===this._order},fromArray:function(i){return this._x=i[0],this._y=i[1],this._z=i[2],void 0!==i[3]&&(this._order=i[3]),this.onChangeCallback(),this},toArray:function(){return[this._x,this._y,this._z,this._order]},onChange:function(i){return this.onChangeCallback=i,this},onChangeCallback:function(){},clone:function(){return new OIMO.Euler(this._x,this._y,this._z,this._order)}},OIMO.EulerToAxis=function(i,t,s){var h=Math.cos(.5*t),e=Math.sin(.5*t),a=Math.cos(.5*s),o=Math.sin(.5*s),n=Math.cos(.5*i),l=Math.sin(.5*i),r=h*a,m=e*o,c=r*n-m*l,x=r*l+m*n,p=e*a*n+h*o*l,u=h*o*n-e*a*l,y=2*Math.acos(c),d=x*x+p*p+u*u;return.001>d?(x=1,p=u=0):(d=Math.sqrt(d),x/=d,p/=d,u/=d),[y,x,p,u]},OIMO.EulerToMatrix=function(i,t,s){var h=Math.cos(t),e=Math.sin(t),a=Math.cos(s),o=Math.sin(s),n=Math.cos(i),l=Math.sin(i),r=new OIMO.Mat33,m=r.elements;return m[0]=h*a,m[1]=e*l-h*o*n,m[2]=h*o*l+e*n,m[3]=o,m[4]=a*n,m[5]=-a*l,m[6]=-e*a,m[7]=e*o*n+h*l,m[8]=-e*o*l+h*n,r},OIMO.MatrixToEuler=function(i){var t,s,h,e=i.elements;return e[3]>.998?(s=Math.atan2(e[2],e[8]),h=Math.PI/2,t=0):e[3]<-.998?(s=Math.atan2(e[2],e[8]),h=-Math.PI/2,t=0):(s=Math.atan2(-e[6],e[0]),t=Math.atan2(-e[5],e[4]),h=Math.asin(e[3])),[t,s,h]},OIMO.unwrapDegrees=function(i){return i%=360,i>180&&(i-=360),-180>i&&(i+=360),i},OIMO.unwrapRadian=function(i){return i%=OIMO.TwoPI,i>Math.PI&&(i-=OIMO.TwoPI),i<-Math.PI&&(i+=OIMO.TwoPI),i},OIMO.Distance3d=function(i,t){var s=t[0]-i[0],h=t[1]-i[1],e=t[2]-i[2];return Math.sqrt(s*s+h*h+e*e)},OIMO.Constraint=function(){this.parent=null,this.body1=null,this.body2=null,this.addedToIsland=!1},OIMO.Constraint.prototype={constructor:OIMO.Constraint,preSolve:function(){throw new Error("Inheritance error.")},solve:function(){throw new Error("Inheritance error.")},postSolve:function(){throw new Error("Inheritance error.")}},OIMO.Joint=function(i){OIMO.Constraint.call(this),this.name="",this.JOINT_DISTANCE=1,this.JOINT_BALL_AND_SOCKET=2,this.JOINT_HINGE=3,this.JOINT_WHEEL=4,this.JOINT_SLIDER=5,this.JOINT_PRISMATIC=6,this.type=0,this.prev=null,this.next=null,this.body1=i.body1,this.body2=i.body2,this.localAnchorPoint1=(new OIMO.Vec3).copy(i.localAnchorPoint1),this.localAnchorPoint2=(new OIMO.Vec3).copy(i.localAnchorPoint2),this.relativeAnchorPoint1=new OIMO.Vec3,this.relativeAnchorPoint2=new OIMO.Vec3,this.anchorPoint1=new OIMO.Vec3,this.anchorPoint2=new OIMO.Vec3,this.allowCollision=i.allowCollision,this.b1Link=new OIMO.JointLink(this),this.b2Link=new OIMO.JointLink(this),this.matrix=new OIMO.Mat44},OIMO.Joint.prototype=Object.create(OIMO.Constraint.prototype),OIMO.Joint.prototype.updateAnchorPoints=function(){var i=this.body1.position,t=this.body2.position,s=this.body1.rotation.elements,h=this.body2.rotation.elements,e=this.localAnchorPoint1.x,a=this.localAnchorPoint1.y,o=this.localAnchorPoint1.z,n=this.localAnchorPoint2.x,l=this.localAnchorPoint2.y,r=this.localAnchorPoint2.z,m=e*s[0]+a*s[1]+o*s[2],c=e*s[3]+a*s[4]+o*s[5],x=e*s[6]+a*s[7]+o*s[8],p=n*h[0]+l*h[1]+r*h[2],u=n*h[3]+l*h[4]+r*h[5],y=n*h[6]+l*h[7]+r*h[8];this.relativeAnchorPoint1.x=m,this.relativeAnchorPoint1.y=c,this.relativeAnchorPoint1.z=x,this.relativeAnchorPoint2.x=p,this.relativeAnchorPoint2.y=u,this.relativeAnchorPoint2.z=y;var d=m+i.x,O=c+i.y,M=x+i.z,I=p+t.x,v=u+t.y,z=y+t.z;this.anchorPoint1.x=d,this.anchorPoint1.y=O,this.anchorPoint1.z=M,this.anchorPoint2.x=I,this.anchorPoint2.y=v,this.anchorPoint2.z=z},OIMO.Joint.prototype.attach=function(){this.b1Link.body=this.body2,this.b2Link.body=this.body1,null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null,this.body1.jointLink=this.b1Link,this.body1.numJoints++,null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null,this.body2.jointLink=this.b2Link,this.body2.numJoints++},OIMO.Joint.prototype.detach=function(){var i=this.b1Link.prev,t=this.b1Link.next;null!=i&&(i.next=t),null!=t&&(t.prev=i),this.body1.jointLink==this.b1Link&&(this.body1.jointLink=t),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.body=null,this.body1.numJoints--,i=this.b2Link.prev,t=this.b2Link.next,null!=i&&(i.next=t),null!=t&&(t.prev=i),this.body2.jointLink==this.b2Link&&(this.body2.jointLink=t),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.body=null,this.body2.numJoints--,this.b1Link.body=null,this.b2Link.body=null},OIMO.Joint.prototype.awake=function(){this.body1.awake(),this.body2.awake()},OIMO.Joint.prototype.preSolve=function(){},OIMO.Joint.prototype.solve=function(){},OIMO.Joint.prototype.postSolve=function(){},OIMO.Joint.prototype.getPosition=function(){var i=(new OIMO.Vec3).scale(this.anchorPoint1,OIMO.WORLD_SCALE),t=(new OIMO.Vec3).scale(this.anchorPoint2,OIMO.WORLD_SCALE);return[i,t]},OIMO.Joint.prototype.getMatrix=function(){var i=this.matrix.elements,t=this.anchorPoint1,s=this.anchorPoint2;return i[0]=t.x*OIMO.WORLD_SCALE,i[1]=t.y*OIMO.WORLD_SCALE,i[2]=t.z*OIMO.WORLD_SCALE,i[3]=0,i[4]=s.x*OIMO.WORLD_SCALE,i[5]=s.y*OIMO.WORLD_SCALE,i[6]=s.z*OIMO.WORLD_SCALE,i[7]=0,i},OIMO.JointConfig=function(){this.body1=null,this.body2=null,this.localAnchorPoint1=new OIMO.Vec3,this.localAnchorPoint2=new OIMO.Vec3,this.localAxis1=new OIMO.Vec3,this.localAxis2=new OIMO.Vec3,this.allowCollision=!1},OIMO.JointLink=function(i){this.prev=null,this.next=null,this.body=null,this.joint=i},OIMO.LimitMotor=function(i,t){this.axis=i,this.angle=0,this.lowerLimit=t?0:1,this.upperLimit=0,this.motorSpeed=0,this.maxMotorForce=0,this.frequency=0,this.dampingRatio=0},OIMO.LimitMotor.prototype={constructor:OIMO.LimitMotor,setLimit:function(i,t){this.lowerLimit=i,this.upperLimit=t},setMotor:function(i,t){this.motorSpeed=i,this.maxMotorForce=t},setSpring:function(i,t){this.frequency=i,this.dampingRatio=t}},OIMO.BallAndSocketJoint=function(i){OIMO.Joint.call(this,i),this.type=this.JOINT_BALL_AND_SOCKET,this.lc=new OIMO.LinearConstraint(this)},OIMO.BallAndSocketJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.BallAndSocketJoint.prototype.preSolve=function(i,t){this.updateAnchorPoints(),this.lc.preSolve(i,t)},OIMO.BallAndSocketJoint.prototype.solve=function(){this.lc.solve()},OIMO.BallAndSocketJoint.prototype.postSolve=function(){},OIMO.DistanceJoint=function(i,t,s){OIMO.Joint.call(this,i),this.type=this.JOINT_DISTANCE,this.normal=new OIMO.Vec3,this.limitMotor=new OIMO.LimitMotor(this.normal,!0),this.limitMotor.lowerLimit=t,this.limitMotor.upperLimit=s,this.t=new OIMO.TranslationalConstraint(this,this.limitMotor)},OIMO.DistanceJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.DistanceJoint.prototype.preSolve=function(i,t){this.updateAnchorPoints();var s=this.anchorPoint2.x-this.anchorPoint1.x,h=this.anchorPoint2.y-this.anchorPoint1.y,e=this.anchorPoint2.z-this.anchorPoint1.z,a=Math.sqrt(s*s+h*h+e*e);a>0&&(a=1/a),this.normal.init(s*a,h*a,e*a),this.t.preSolve(i,t)},OIMO.DistanceJoint.prototype.solve=function(){this.t.solve()},OIMO.DistanceJoint.prototype.postSolve=function(){},OIMO.HingeJoint=function(i,t,s){OIMO.Joint.call(this,i),this.type=this.JOINT_HINGE,this.localAxis1=(new OIMO.Vec3).normalize(i.localAxis1),this.localAxis2=(new OIMO.Vec3).normalize(i.localAxis2);var h;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,h=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=h,this.localAngAxis1Y*=h,this.localAngAxis1Z*=h,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var e=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)),a=e.elements;this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*a[1]+this.localAngAxis1Z*a[2],this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5],this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8],this.nor=new OIMO.Vec3,this.tan=new OIMO.Vec3,this.bin=new OIMO.Vec3,this.limitMotor=new OIMO.LimitMotor(this.nor,!1),this.limitMotor.lowerLimit=t,this.limitMotor.upperLimit=s,this.lc=new OIMO.LinearConstraint(this),this.r3=new OIMO.Rotational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))},OIMO.HingeJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.HingeJoint.prototype.preSolve=function(i,t){var s,h,e,a;this.updateAnchorPoints(),s=this.body1.rotation.elements;var o=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],n=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],l=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],r=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],m=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],c=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var x=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],p=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],u=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],y=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],d=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],O=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8],M=o*this.body2.inverseMass+x*this.body1.inverseMass,I=n*this.body2.inverseMass+p*this.body1.inverseMass,v=l*this.body2.inverseMass+u*this.body1.inverseMass;h=Math.sqrt(M*M+I*I+v*v),h>0&&(h=1/h),M*=h,I*=h,v*=h;var z=I*M-v*v,f=-v*I-M*M,b=M*v+I*I;h=1/Math.sqrt(z*z+f*f+b*b),z*=h,f*=h,b*=h;var A=I*b-v*f,k=v*z-M*b,g=M*f-I*z;this.nor.init(M,I,v),this.tan.init(z,f,b),this.bin.init(A,k,g),this.limitMotor.angle=0>M*(m*O-c*d)+I*(c*y-r*O)+v*(r*d-m*y)?-this.acosClamp(r*y+m*d+c*O):this.acosClamp(r*y+m*d+c*O),h=n*u-l*p,e=l*x-o*u,a=o*p-n*x,this.r3.limitMotor2.angle=z*h+f*e+b*a,this.r3.limitMotor3.angle=A*h+k*e+g*a,this.r3.preSolve(i,t),this.lc.preSolve(i,t)},OIMO.HingeJoint.prototype.solve=function(){this.r3.solve(),this.lc.solve()},OIMO.HingeJoint.prototype.postSolve=function(){},OIMO.HingeJoint.prototype.acosClamp=function(i){return i>1?0:-1>i?Math.PI:Math.acos(i)},OIMO.PrismaticJoint=function(i,t,s){OIMO.Joint.call(this,i),this.type=this.JOINT_PRISMATIC,this.localAxis1=(new OIMO.Vec3).normalize(i.localAxis1),this.localAxis2=(new OIMO.Vec3).normalize(i.localAxis2),this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z,this.nor=new OIMO.Vec3,this.tan=new OIMO.Vec3,this.bin=new OIMO.Vec3,this.ac=new OIMO.AngularConstraint(this,(new OIMO.Quat).arc(this.localAxis1,this.localAxis2)),this.limitMotor=new OIMO.LimitMotor(this.nor,!0),this.limitMotor.lowerLimit=t,this.limitMotor.upperLimit=s,this.t3=new OIMO.Translational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))},OIMO.PrismaticJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.PrismaticJoint.prototype.preSolve=function(i,t){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var e=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],a=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],o=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8];s=this.body2.rotation.elements;var n=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],l=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],r=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],m=e*this.body2.inverseMass+n*this.body1.inverseMass,c=a*this.body2.inverseMass+l*this.body1.inverseMass,x=o*this.body2.inverseMass+r*this.body1.inverseMass;h=Math.sqrt(m*m+c*c+x*x),h>0&&(h=1/h),m*=h,c*=h,x*=h;var p=c*m-x*x,u=-x*c-m*m,y=m*x+c*c;h=1/Math.sqrt(p*p+u*u+y*y),p*=h,u*=h,y*=h;var d=c*y-x*u,O=x*p-m*y,M=m*u-c*p;this.nor.init(m,c,x),this.tan.init(p,u,y),this.bin.init(d,O,M),this.ac.preSolve(i,t),this.t3.preSolve(i,t)},OIMO.PrismaticJoint.prototype.solve=function(){this.ac.solve(),this.t3.solve()},OIMO.PrismaticJoint.prototype.postSolve=function(){},OIMO.SliderJoint=function(i,t,s){OIMO.Joint.call(this,i),this.type=this.JOINT_SLIDER,this.localAxis1=(new OIMO.Vec3).normalize(i.localAxis1),this.localAxis2=(new OIMO.Vec3).normalize(i.localAxis2);var h;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,h=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=h,this.localAngAxis1Y*=h,this.localAngAxis1Z*=h,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var e=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)),a=e.elements;this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*a[1]+this.localAngAxis1Z*a[2],this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5],this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8],this.nor=new OIMO.Vec3,this.tan=new OIMO.Vec3,this.bin=new OIMO.Vec3,this.rotationalLimitMotor=new OIMO.LimitMotor(this.nor,!1),this.r3=new OIMO.Rotational3Constraint(this,this.rotationalLimitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0)),this.translationalLimitMotor=new OIMO.LimitMotor(this.nor,!0),this.translationalLimitMotor.lowerLimit=t,this.translationalLimitMotor.upperLimit=s,this.t3=new OIMO.Translational3Constraint(this,this.translationalLimitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))},OIMO.SliderJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.SliderJoint.prototype.preSolve=function(i,t){var s,h,e,a;this.updateAnchorPoints(),s=this.body1.rotation.elements;var o=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],n=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],l=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],r=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],m=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],c=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var x=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],p=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],u=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],y=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],d=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],O=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8],M=o*this.body2.inverseMass+x*this.body1.inverseMass,I=n*this.body2.inverseMass+p*this.body1.inverseMass,v=l*this.body2.inverseMass+u*this.body1.inverseMass;h=Math.sqrt(M*M+I*I+v*v),h>0&&(h=1/h),M*=h,I*=h,v*=h;var z=I*M-v*v,f=-v*I-M*M,b=M*v+I*I;h=1/Math.sqrt(z*z+f*f+b*b),z*=h,f*=h,b*=h;var A=I*b-v*f,k=v*z-M*b,g=M*f-I*z;this.nor.init(M,I,v),this.tan.init(z,f,b),this.bin.init(A,k,g),this.rotationalLimitMotor.angle=0>M*(m*O-c*d)+I*(c*y-r*O)+v*(r*d-m*y)?-this.acosClamp(r*y+m*d+c*O):this.acosClamp(r*y+m*d+c*O),h=n*u-l*p,e=l*x-o*u,a=o*p-n*x,this.r3.limitMotor2.angle=z*h+f*e+b*a,this.r3.limitMotor3.angle=A*h+k*e+g*a,this.r3.preSolve(i,t),this.t3.preSolve(i,t)},OIMO.SliderJoint.prototype.solve=function(){this.r3.solve(),this.t3.solve()},OIMO.SliderJoint.prototype.postSolve=function(){},OIMO.SliderJoint.prototype.acosClamp=function(i){return i>1?0:-1>i?Math.PI:Math.acos(i)},OIMO.WheelJoint=function(i){OIMO.Joint.call(this,i),this.type=this.JOINT_WHEEL,this.localAxis1=(new OIMO.Vec3).normalize(i.localAxis1),this.localAxis2=(new OIMO.Vec3).normalize(i.localAxis2);var t;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var s=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;if(s>-1&&1>s)this.localAngAxis1X=this.localAxis2X-s*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-s*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-s*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-s*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-s*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-s*this.localAxis2Z,t=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=t,this.localAngAxis1Y*=t,this.localAngAxis1Z*=t,t=1/Math.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=t,this.localAngAxis2Y*=t,this.localAngAxis2Z*=t;else{this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,t=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=t,this.localAngAxis1Y*=t,this.localAngAxis1Z*=t;var h=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)),e=h.elements;this.localAngAxis2X=this.localAngAxis1X*e[0]+this.localAngAxis1Y*e[1]+this.localAngAxis1Z*e[2],this.localAngAxis2Y=this.localAngAxis1X*e[3]+this.localAngAxis1Y*e[4]+this.localAngAxis1Z*e[5],this.localAngAxis2Z=this.localAngAxis1X*e[6]+this.localAngAxis1Y*e[7]+this.localAngAxis1Z*e[8]}this.nor=new OIMO.Vec3,this.tan=new OIMO.Vec3,this.bin=new OIMO.Vec3,this.translationalLimitMotor=new OIMO.LimitMotor(this.tan,!0),this.translationalLimitMotor.frequency=8,this.translationalLimitMotor.dampingRatio=1,this.rotationalLimitMotor1=new OIMO.LimitMotor(this.tan,!1),this.rotationalLimitMotor2=new OIMO.LimitMotor(this.bin,!1),this.t3=new OIMO.Translational3Constraint(this,new OIMO.LimitMotor(this.nor,!0),this.translationalLimitMotor,new OIMO.LimitMotor(this.bin,!0)),this.t3.weight=1,this.r3=new OIMO.Rotational3Constraint(this,new OIMO.LimitMotor(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)},OIMO.WheelJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.WheelJoint.prototype.preSolve=function(i,t){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var e=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],a=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],o=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],n=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],l=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],r=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var m=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],c=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],x=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],p=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],u=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],y=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8];this.r3.limitMotor1.angle=e*m+a*c+o*x,this.rotationalLimitMotor1.angle=0>e*(l*x-r*c)+a*(r*m-n*x)+o*(n*c-l*m)?-this.acosClamp(n*m+l*c+r*x):this.acosClamp(n*m+l*c+r*x),this.rotationalLimitMotor2.angle=0>m*(u*o-y*a)+c*(y*e-p*o)+x*(p*a-u*e)?this.acosClamp(p*e+u*a+y*o):-this.acosClamp(p*e+u*a+y*o);var d=c*o-x*a,O=x*e-m*o,M=m*a-c*e;h=Math.sqrt(d*d+O*O+M*M),h>0&&(h=1/h),d*=h,O*=h,M*=h;var I=O*x-M*c,v=M*m-d*x,z=d*c-O*m;h=Math.sqrt(I*I+v*v+z*z),h>0&&(h=1/h),I*=h,v*=h,z*=h;var f=a*M-o*O,b=o*d-e*M,A=e*O-a*d;h=Math.sqrt(f*f+b*b+A*A),h>0&&(h=1/h),f*=h,b*=h,A*=h,this.nor.init(d,O,M),this.tan.init(I,v,z),this.bin.init(f,b,A),this.r3.preSolve(i,t),this.t3.preSolve(i,t)},OIMO.WheelJoint.prototype.solve=function(){this.r3.solve(),this.t3.solve()},OIMO.WheelJoint.prototype.postSolve=function(){},OIMO.WheelJoint.prototype.acosClamp=function(i){return i>1?0:-1>i?Math.PI:Math.acos(i)},OIMO.AngularConstraint=function(i,t){this.i1e00=0/0,this.i1e01=0/0,this.i1e02=0/0,this.i1e10=0/0,this.i1e11=0/0,this.i1e12=0/0,this.i1e20=0/0,this.i1e21=0/0,this.i1e22=0/0,this.i2e00=0/0,this.i2e01=0/0,this.i2e02=0/0,this.i2e10=0/0,this.i2e11=0/0,this.i2e12=0/0,this.i2e20=0/0,this.i2e21=0/0,this.i2e22=0/0,this.d00=0/0,this.d01=0/0,this.d02=0/0,this.d10=0/0,this.d11=0/0,this.d12=0/0,this.d20=0/0,this.d21=0/0,this.d22=0/0,this.ax=0/0,this.ay=0/0,this.az=0/0,this.velx=0/0,this.vely=0/0,this.velz=0/0,this.joint=i,this.targetOrientation=(new OIMO.Quat).invert(t),this.relativeOrientation=new OIMO.Quat,this.b1=i.body1,this.b2=i.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.impx=0,this.impy=0,this.impz=0},OIMO.AngularConstraint.prototype={constructor:OIMO.AngularConstraint,preSolve:function(i,t){var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.i1e00+this.i2e00,a=this.i1e01+this.i2e01,o=this.i1e02+this.i2e02,n=this.i1e10+this.i2e10,l=this.i1e11+this.i2e11,r=this.i1e12+this.i2e12,m=this.i1e20+this.i2e20,c=this.i1e21+this.i2e21,x=this.i1e22+this.i2e22,p=1/(e*(l*x-c*r)+n*(c*o-a*x)+m*(a*r-l*o));this.d00=(l*x-r*c)*p,this.d01=(o*c-a*x)*p,this.d02=(a*r-o*l)*p,this.d10=(r*m-n*x)*p,this.d11=(e*x-o*m)*p,this.d12=(o*n-e*r)*p,this.d20=(n*c-l*m)*p,this.d21=(a*m-e*c)*p,this.d22=(e*l-a*n)*p,this.relativeOrientation.invert(this.b1.orientation),this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation),this.relativeOrientation.mul(this.b2.orientation,this.relativeOrientation),p=2*this.relativeOrientation.s,this.velx=this.relativeOrientation.x*p,this.vely=this.relativeOrientation.y*p,this.velz=this.relativeOrientation.z*p;var u=Math.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);u>.02?(u=(.02-u)/u*t*.05,this.velx*=u,this.vely*=u,this.velz*=u):(this.velx=0,this.vely=0,this.velz=0),this.a1.x+=this.impx*this.i1e00+this.impy*this.i1e01+this.impz*this.i1e02,this.a1.y+=this.impx*this.i1e10+this.impy*this.i1e11+this.impz*this.i1e12,this.a1.z+=this.impx*this.i1e20+this.impy*this.i1e21+this.impz*this.i1e22,this.a2.x-=this.impx*this.i2e00+this.impy*this.i2e01+this.impz*this.i2e02,this.a2.y-=this.impx*this.i2e10+this.impy*this.i2e11+this.impz*this.i2e12,this.a2.z-=this.impx*this.i2e20+this.impy*this.i2e21+this.impz*this.i2e22},solve:function(){var i=this.a2.x-this.a1.x-this.velx,t=this.a2.y-this.a1.y-this.vely,s=this.a2.z-this.a1.z-this.velz,h=i*this.d00+t*this.d01+s*this.d02,e=i*this.d10+t*this.d11+s*this.d12,a=i*this.d20+t*this.d21+s*this.d22;this.impx+=h,this.impy+=e,this.impz+=a,this.a1.x+=h*this.i1e00+e*this.i1e01+a*this.i1e02,this.a1.y+=h*this.i1e10+e*this.i1e11+a*this.i1e12,this.a1.z+=h*this.i1e20+e*this.i1e21+a*this.i1e22,this.a2.x-=h*this.i2e00+e*this.i2e01+a*this.i2e02,this.a2.y-=h*this.i2e10+e*this.i2e11+a*this.i2e12,this.a2.z-=h*this.i2e20+e*this.i2e21+a*this.i2e22}},OIMO.LinearConstraint=function(i){this.m1=0/0,this.m2=0/0,this.i1e00=0/0,this.i1e01=0/0,this.i1e02=0/0,this.i1e10=0/0,this.i1e11=0/0,this.i1e12=0/0,this.i1e20=0/0,this.i1e21=0/0,this.i1e22=0/0,this.i2e00=0/0,this.i2e01=0/0,this.i2e02=0/0,this.i2e10=0/0,this.i2e11=0/0,this.i2e12=0/0,this.i2e20=0/0,this.i2e21=0/0,this.i2e22=0/0,this.d00=0/0,this.d01=0/0,this.d02=0/0,this.d10=0/0,this.d11=0/0,this.d12=0/0,this.d20=0/0,this.d21=0/0,this.d22=0/0,this.r1x=0/0,this.r1y=0/0,this.r1z=0/0,this.r2x=0/0,this.r2y=0/0,this.r2z=0/0,this.ax1x=0/0,this.ax1y=0/0,this.ax1z=0/0,this.ay1x=0/0,this.ay1y=0/0,this.ay1z=0/0,this.az1x=0/0,this.az1y=0/0,this.az1z=0/0,this.ax2x=0/0,this.ax2y=0/0,this.ax2z=0/0,this.ay2x=0/0,this.ay2y=0/0,this.ay2z=0/0,this.az2x=0/0,this.az2y=0/0,this.az2z=0/0,this.vel=0/0,this.velx=0/0,this.vely=0/0,this.velz=0/0,this.joint=i,this.r1=i.relativeAnchorPoint1,this.r2=i.relativeAnchorPoint2,this.p1=i.anchorPoint1,this.p2=i.anchorPoint2,this.b1=i.body1,this.b2=i.body2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.impx=0,this.impy=0,this.impz=0},OIMO.LinearConstraint.prototype={constructor:OIMO.LinearConstraint,preSolve:function(i,t){this.r1x=this.r1.x,this.r1y=this.r1.y,this.r1z=this.r1.z,this.r2x=this.r2.x,this.r2y=this.r2.y,this.r2z=this.r2.z,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8],this.ax1x=this.r1z*this.i1e01+-this.r1y*this.i1e02,this.ax1y=this.r1z*this.i1e11+-this.r1y*this.i1e12,this.ax1z=this.r1z*this.i1e21+-this.r1y*this.i1e22,this.ay1x=-this.r1z*this.i1e00+this.r1x*this.i1e02,this.ay1y=-this.r1z*this.i1e10+this.r1x*this.i1e12,this.ay1z=-this.r1z*this.i1e20+this.r1x*this.i1e22,this.az1x=this.r1y*this.i1e00+-this.r1x*this.i1e01,this.az1y=this.r1y*this.i1e10+-this.r1x*this.i1e11,this.az1z=this.r1y*this.i1e20+-this.r1x*this.i1e21,this.ax2x=this.r2z*this.i2e01+-this.r2y*this.i2e02,this.ax2y=this.r2z*this.i2e11+-this.r2y*this.i2e12,this.ax2z=this.r2z*this.i2e21+-this.r2y*this.i2e22,this.ay2x=-this.r2z*this.i2e00+this.r2x*this.i2e02,this.ay2y=-this.r2z*this.i2e10+this.r2x*this.i2e12,this.ay2z=-this.r2z*this.i2e20+this.r2x*this.i2e22,this.az2x=this.r2y*this.i2e00+-this.r2x*this.i2e01,this.az2y=this.r2y*this.i2e10+-this.r2x*this.i2e11,this.az2z=this.r2y*this.i2e20+-this.r2x*this.i2e21;var e=this.m1+this.m2,a=0,o=0,n=0,l=e,r=0,m=0,c=0,x=e;e+=this.i1e11*this.r1z*this.r1z-(this.i1e21+this.i1e12)*this.r1y*this.r1z+this.i1e22*this.r1y*this.r1y,a+=(this.i1e20*this.r1y+this.i1e12*this.r1x)*this.r1z-this.i1e10*this.r1z*this.r1z-this.i1e22*this.r1x*this.r1y,o+=(this.i1e10*this.r1y-this.i1e11*this.r1x)*this.r1z-this.i1e20*this.r1y*this.r1y+this.i1e21*this.r1x*this.r1y,n+=(this.i1e02*this.r1y+this.i1e21*this.r1x)*this.r1z-this.i1e01*this.r1z*this.r1z-this.i1e22*this.r1x*this.r1y,l+=this.i1e00*this.r1z*this.r1z-(this.i1e20+this.i1e02)*this.r1x*this.r1z+this.i1e22*this.r1x*this.r1x,r+=(this.i1e01*this.r1x-this.i1e00*this.r1y)*this.r1z-this.i1e21*this.r1x*this.r1x+this.i1e20*this.r1x*this.r1y,m+=(this.i1e01*this.r1y-this.i1e11*this.r1x)*this.r1z-this.i1e02*this.r1y*this.r1y+this.i1e12*this.r1x*this.r1y,c+=(this.i1e10*this.r1x-this.i1e00*this.r1y)*this.r1z-this.i1e12*this.r1x*this.r1x+this.i1e02*this.r1x*this.r1y,x+=this.i1e00*this.r1y*this.r1y-(this.i1e10+this.i1e01)*this.r1x*this.r1y+this.i1e11*this.r1x*this.r1x,e+=this.i2e11*this.r2z*this.r2z-(this.i2e21+this.i2e12)*this.r2y*this.r2z+this.i2e22*this.r2y*this.r2y,a+=(this.i2e20*this.r2y+this.i2e12*this.r2x)*this.r2z-this.i2e10*this.r2z*this.r2z-this.i2e22*this.r2x*this.r2y,o+=(this.i2e10*this.r2y-this.i2e11*this.r2x)*this.r2z-this.i2e20*this.r2y*this.r2y+this.i2e21*this.r2x*this.r2y,n+=(this.i2e02*this.r2y+this.i2e21*this.r2x)*this.r2z-this.i2e01*this.r2z*this.r2z-this.i2e22*this.r2x*this.r2y,l+=this.i2e00*this.r2z*this.r2z-(this.i2e20+this.i2e02)*this.r2x*this.r2z+this.i2e22*this.r2x*this.r2x,r+=(this.i2e01*this.r2x-this.i2e00*this.r2y)*this.r2z-this.i2e21*this.r2x*this.r2x+this.i2e20*this.r2x*this.r2y,m+=(this.i2e01*this.r2y-this.i2e11*this.r2x)*this.r2z-this.i2e02*this.r2y*this.r2y+this.i2e12*this.r2x*this.r2y,c+=(this.i2e10*this.r2x-this.i2e00*this.r2y)*this.r2z-this.i2e12*this.r2x*this.r2x+this.i2e02*this.r2x*this.r2y,x+=this.i2e00*this.r2y*this.r2y-(this.i2e10+this.i2e01)*this.r2x*this.r2y+this.i2e11*this.r2x*this.r2x;var p=1/(e*(l*x-c*r)+n*(c*o-a*x)+m*(a*r-l*o));this.d00=(l*x-r*c)*p,this.d01=(o*c-a*x)*p,this.d02=(a*r-o*l)*p,this.d10=(r*m-n*x)*p,this.d11=(e*x-o*m)*p,this.d12=(o*n-e*r)*p,this.d20=(n*c-l*m)*p,this.d21=(a*m-e*c)*p,this.d22=(e*l-a*n)*p,this.velx=this.p2.x-this.p1.x,this.vely=this.p2.y-this.p1.y,this.velz=this.p2.z-this.p1.z;var u=Math.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);
u>.005?(u=(.005-u)/u*t*.05,this.velx*=u,this.vely*=u,this.velz*=u):(this.velx=0,this.vely=0,this.velz=0),this.impx*=.95,this.impy*=.95,this.impz*=.95,this.l1.x+=this.impx*this.m1,this.l1.y+=this.impy*this.m1,this.l1.z+=this.impz*this.m1,this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x,this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y,this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z,this.l2.x-=this.impx*this.m2,this.l2.y-=this.impy*this.m2,this.l2.z-=this.impz*this.m2,this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x,this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y,this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var i=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,t=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,s=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,h=i*this.d00+t*this.d01+s*this.d02,e=i*this.d10+t*this.d11+s*this.d12,a=i*this.d20+t*this.d21+s*this.d22;this.impx+=h,this.impy+=e,this.impz+=a,this.l1.x+=h*this.m1,this.l1.y+=e*this.m1,this.l1.z+=a*this.m1,this.a1.x+=h*this.ax1x+e*this.ay1x+a*this.az1x,this.a1.y+=h*this.ax1y+e*this.ay1y+a*this.az1y,this.a1.z+=h*this.ax1z+e*this.ay1z+a*this.az1z,this.l2.x-=h*this.m2,this.l2.y-=e*this.m2,this.l2.z-=a*this.m2,this.a2.x-=h*this.ax2x+e*this.ay2x+a*this.az2x,this.a2.y-=h*this.ax2y+e*this.ay2y+a*this.az2y,this.a2.z-=h*this.ax2z+e*this.ay2z+a*this.az2z}},OIMO.Rotational3Constraint=function(i,t,s,h){this.cfm1=0/0,this.cfm2=0/0,this.cfm3=0/0,this.i1e00=0/0,this.i1e01=0/0,this.i1e02=0/0,this.i1e10=0/0,this.i1e11=0/0,this.i1e12=0/0,this.i1e20=0/0,this.i1e21=0/0,this.i1e22=0/0,this.i2e00=0/0,this.i2e01=0/0,this.i2e02=0/0,this.i2e10=0/0,this.i2e11=0/0,this.i2e12=0/0,this.i2e20=0/0,this.i2e21=0/0,this.i2e22=0/0,this.ax1=0/0,this.ay1=0/0,this.az1=0/0,this.ax2=0/0,this.ay2=0/0,this.az2=0/0,this.ax3=0/0,this.ay3=0/0,this.az3=0/0,this.a1x1=0/0,this.a1y1=0/0,this.a1z1=0/0,this.a2x1=0/0,this.a2y1=0/0,this.a2z1=0/0,this.a1x2=0/0,this.a1y2=0/0,this.a1z2=0/0,this.a2x2=0/0,this.a2y2=0/0,this.a2z2=0/0,this.a1x3=0/0,this.a1y3=0/0,this.a1z3=0/0,this.a2x3=0/0,this.a2y3=0/0,this.a2z3=0/0,this.lowerLimit1=0/0,this.upperLimit1=0/0,this.limitVelocity1=0/0,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=0/0,this.maxMotorForce1=0/0,this.maxMotorImpulse1=0/0,this.lowerLimit2=0/0,this.upperLimit2=0/0,this.limitVelocity2=0/0,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=0/0,this.maxMotorForce2=0/0,this.maxMotorImpulse2=0/0,this.lowerLimit3=0/0,this.upperLimit3=0/0,this.limitVelocity3=0/0,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=0/0,this.maxMotorForce3=0/0,this.maxMotorImpulse3=0/0,this.k00=0/0,this.k01=0/0,this.k02=0/0,this.k10=0/0,this.k11=0/0,this.k12=0/0,this.k20=0/0,this.k21=0/0,this.k22=0/0,this.kv00=0/0,this.kv11=0/0,this.kv22=0/0,this.dv00=0/0,this.dv11=0/0,this.dv22=0/0,this.d00=0/0,this.d01=0/0,this.d02=0/0,this.d10=0/0,this.d11=0/0,this.d12=0/0,this.d20=0/0,this.d21=0/0,this.d22=0/0,this.limitMotor1=t,this.limitMotor2=s,this.limitMotor3=h,this.b1=i.body1,this.b2=i.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0},OIMO.Rotational3Constraint.prototype={constructor:OIMO.Rotational3Constraint,preSolve:function(i,t){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor1.frequency,a=this.limitMotor2.frequency,o=this.limitMotor3.frequency,n=e>0,l=a>0,r=o>0,m=this.lowerLimit1<=this.upperLimit1,c=this.lowerLimit2<=this.upperLimit2,x=this.lowerLimit3<=this.upperLimit3,p=this.limitMotor1.angle;m?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-p):p<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-p):p>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-p):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),n||(this.limitVelocity1>.02?this.limitVelocity1-=.02:this.limitVelocity1<-.02?this.limitVelocity1+=.02:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0);var u=this.limitMotor2.angle;c?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-u):u<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-u):u>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-u):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),l||(this.limitVelocity2>.02?this.limitVelocity2-=.02:this.limitVelocity2<-.02?this.limitVelocity2+=.02:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0);var y=this.limitMotor3.angle;if(x?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-y):y<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-y):y>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-y):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),r||(this.limitVelocity3>.02?this.limitVelocity3-=.02:this.limitVelocity3<-.02?this.limitVelocity3+=.02:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||n)?this.maxMotorImpulse1=this.maxMotorForce1*i:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||l)?this.maxMotorImpulse2=this.maxMotorForce2*i:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||r)?this.maxMotorImpulse3=this.maxMotorForce3*i:(this.motorImpulse3=0,this.maxMotorImpulse3=0),this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02,this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12,this.a1z1=this.ax1*this.i1e20+this.ay1*this.i1e21+this.az1*this.i1e22,this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02,this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12,this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22,this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02,this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12,this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22,this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+this.az2*this.i2e02,this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12,this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22,this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02,this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12,this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22,this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02,this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12,this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22,this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1),this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2),this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3),this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1),this.k11=this.ax2*(this.a1x2+this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2),this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3),this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1),this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2),this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3),this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,n&&2!=this.limitState1){var d=6.2831853*e,O=d*d*i,M=t/(O+2*this.limitMotor1.dampingRatio*d);this.cfm1=this.kv00*M,this.limitVelocity1*=O*M}else this.cfm1=0,this.limitVelocity1*=.05*t;l&&2!=this.limitState2?(d=6.2831853*a,O=d*d*i,M=t/(O+2*this.limitMotor2.dampingRatio*d),this.cfm2=this.kv11*M,this.limitVelocity2*=O*M):(this.cfm2=0,this.limitVelocity2*=.05*t),r&&2!=this.limitState3?(d=6.2831853*o,O=d*d*i,M=t/(O+2*this.limitMotor3.dampingRatio*d),this.cfm3=this.kv22*M,this.limitVelocity3*=O*M):(this.cfm3=0,this.limitVelocity3*=.05*t),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var I=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*I,this.d01=(this.k02*this.k21-this.k01*this.k22)*I,this.d02=(this.k01*this.k12-this.k02*this.k11)*I,this.d10=(this.k12*this.k20-this.k10*this.k22)*I,this.d11=(this.k00*this.k22-this.k02*this.k20)*I,this.d12=(this.k02*this.k10-this.k00*this.k12)*I,this.d20=(this.k10*this.k21-this.k11*this.k20)*I,this.d21=(this.k01*this.k20-this.k00*this.k21)*I,this.d22=(this.k00*this.k11-this.k01*this.k10)*I,this.limitImpulse1*=.95,this.motorImpulse1*=.95,this.limitImpulse2*=.95,this.motorImpulse2*=.95,this.limitImpulse3*=.95,this.motorImpulse3*=.95;var v=this.limitImpulse1+this.motorImpulse1,z=this.limitImpulse2+this.motorImpulse2,f=this.limitImpulse3+this.motorImpulse3;this.a1.x+=v*this.a1x1+z*this.a1x2+f*this.a1x3,this.a1.y+=v*this.a1y1+z*this.a1y2+f*this.a1y3,this.a1.z+=v*this.a1z1+z*this.a1z2+f*this.a1z3,this.a2.x-=v*this.a2x1+z*this.a2x2+f*this.a2x3,this.a2.y-=v*this.a2y1+z*this.a2y2+f*this.a2y3,this.a2.z-=v*this.a2z1+z*this.a2z2+f*this.a2z3},solve_:function(){var i=this.a2.x-this.a1.x,t=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z;this.limitVelocity3=30;var h=i*this.ax1+t*this.ay1+s*this.az1-this.limitVelocity1,e=i*this.ax2+t*this.ay2+s*this.az2-this.limitVelocity2,a=i*this.ax3+t*this.ay3+s*this.az3-this.limitVelocity3,o=h*this.d00+e*this.d01+a*this.d02,n=h*this.d10+e*this.d11+a*this.d12,l=h*this.d20+e*this.d21+a*this.d22;this.limitImpulse1+=o,this.limitImpulse2+=n,this.limitImpulse3+=l,this.a1.x+=o*this.a1x1+n*this.a1x2+l*this.a1x3,this.a1.y+=o*this.a1y1+n*this.a1y2+l*this.a1y3,this.a1.z+=o*this.a1z1+n*this.a1z2+l*this.a1z3,this.a2.x-=o*this.a2x1+n*this.a2x2+l*this.a2x3,this.a2.y-=o*this.a2y1+n*this.a2y2+l*this.a2y3,this.a2.z-=o*this.a2z1+n*this.a2z2+l*this.a2z3},solve:function(){var i=this.a2.x-this.a1.x,t=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,h=i*this.ax1+t*this.ay1+s*this.az1,e=i*this.ax2+t*this.ay2+s*this.az2,a=i*this.ax3+t*this.ay3+s*this.az3,o=this.motorImpulse1,n=this.motorImpulse2,l=this.motorImpulse3,r=0,m=0,c=0;this.enableMotor1&&(r=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=r,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),r=this.motorImpulse1-o),this.enableMotor2&&(m=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=m,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),m=this.motorImpulse2-n),this.enableMotor3&&(c=(a-this.motorSpeed3)*this.dv22,this.motorImpulse3+=c,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),c=this.motorImpulse3-l),h+=r*this.kv00+m*this.k01+c*this.k02,e+=r*this.k10+m*this.kv11+c*this.k12,a+=r*this.k20+m*this.k21+c*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,a-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var x=this.limitImpulse1,p=this.limitImpulse2,u=this.limitImpulse3,y=h*this.d00+e*this.d01+a*this.d02,d=h*this.d10+e*this.d11+a*this.d12,O=h*this.d20+e*this.d21+a*this.d22;this.limitImpulse1+=y,this.limitImpulse2+=d,this.limitImpulse3+=O;var M=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(y=-x,e+=y*this.k10,a+=y*this.k20,M|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(d=-p,h+=d*this.k01,a+=d*this.k21,M|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(O=-u,h+=O*this.k02,e+=O*this.k12,M|=4);var I;switch(M){case 1:I=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*a)*I,O=(-this.k21*e+this.k11*a)*I;break;case 2:I=1/(this.k00*this.k22-this.k02*this.k20),y=(this.k22*h+-this.k02*a)*I,O=(-this.k20*h+this.k00*a)*I;break;case 3:O=a/this.k22;break;case 4:I=1/(this.k00*this.k11-this.k01*this.k10),y=(this.k11*h+-this.k01*e)*I,d=(-this.k10*h+this.k00*e)*I;break;case 5:d=e/this.k11;break;case 6:y=h/this.k00}this.limitImpulse1=y+x,this.limitImpulse2=d+p,this.limitImpulse3=O+u;var v=r+y,z=m+d,f=c+O;this.a1.x+=v*this.a1x1+z*this.a1x2+f*this.a1x3,this.a1.y+=v*this.a1y1+z*this.a1y2+f*this.a1y3,this.a1.z+=v*this.a1z1+z*this.a1z2+f*this.a1z3,this.a2.x-=v*this.a2x1+z*this.a2x2+f*this.a2x3,this.a2.y-=v*this.a2y1+z*this.a2y2+f*this.a2y3,this.a2.z-=v*this.a2z1+z*this.a2z2+f*this.a2z3,i=this.a2.x-this.a1.x,t=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,e=i*this.ax2+t*this.ay2+s*this.az2}},OIMO.RotationalConstraint=function(i,t){this.cfm=0/0,this.i1e00=0/0,this.i1e01=0/0,this.i1e02=0/0,this.i1e10=0/0,this.i1e11=0/0,this.i1e12=0/0,this.i1e20=0/0,this.i1e21=0/0,this.i1e22=0/0,this.i2e00=0/0,this.i2e01=0/0,this.i2e02=0/0,this.i2e10=0/0,this.i2e11=0/0,this.i2e12=0/0,this.i2e20=0/0,this.i2e21=0/0,this.i2e22=0/0,this.motorDenom=0/0,this.invMotorDenom=0/0,this.invDenom=0/0,this.ax=0/0,this.ay=0/0,this.az=0/0,this.a1x=0/0,this.a1y=0/0,this.a1z=0/0,this.a2x=0/0,this.a2y=0/0,this.a2z=0/0,this.enableLimit=!1,this.lowerLimit=0/0,this.upperLimit=0/0,this.limitVelocity=0/0,this.limitState=0,this.enableMotor=!1,this.motorSpeed=0/0,this.maxMotorForce=0/0,this.maxMotorImpulse=0/0,this.limitMotor=t,this.b1=i.body1,this.b2=i.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0},OIMO.RotationalConstraint.prototype={constructor:OIMO.RotationalConstraint,preSolve:function(i,t){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor.frequency,a=e>0,o=this.lowerLimit<=this.upperLimit,n=this.limitMotor.angle;if(o?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n):n<this.lowerLimit?(-1!=this.limitState&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n):n>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-n):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),a||(this.limitVelocity>.02?this.limitVelocity-=.02:this.limitVelocity<-.02?this.limitVelocity+=.02:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||a)?this.maxMotorImpulse=this.maxMotorForce*i:(this.motorImpulse=0,this.maxMotorImpulse=0),this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02,this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12,this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22,this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02,this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12,this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22,this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z),this.invMotorDenom=1/this.motorDenom,a&&2!=this.limitState){var l=6.2831853*e,r=l*l*i,m=t/(r+2*this.limitMotor.dampingRatio*l);this.cfm=this.motorDenom*m,this.limitVelocity*=r*m}else this.cfm=0,this.limitVelocity*=.05*t;this.invDenom=1/(this.motorDenom+this.cfm),this.limitImpulse*=.95,this.motorImpulse*=.95;var c=this.limitImpulse+this.motorImpulse;this.a1.x+=c*this.a1x,this.a1.y+=c*this.a1y,this.a1.z+=c*this.a1z,this.a2.x-=c*this.a2x,this.a2.y-=c*this.a2y,this.a2.z-=c*this.a2z},solve:function(){var i,t=this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z);if(this.enableMotor){i=(t-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=i,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),i=this.motorImpulse-s,t-=i*this.motorDenom}else i=0;var h;if(2!=this.limitState){h=(t-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var a=h+i;this.a1.x+=a*this.a1x,this.a1.y+=a*this.a1y,this.a1.z+=a*this.a1z,this.a2.x-=a*this.a2x,this.a2.y-=a*this.a2y,this.a2.z-=a*this.a2z}},OIMO.Translational3Constraint=function(i,t,s,h){this.m1=0/0,this.m2=0/0,this.i1e00=0/0,this.i1e01=0/0,this.i1e02=0/0,this.i1e10=0/0,this.i1e11=0/0,this.i1e12=0/0,this.i1e20=0/0,this.i1e21=0/0,this.i1e22=0/0,this.i2e00=0/0,this.i2e01=0/0,this.i2e02=0/0,this.i2e10=0/0,this.i2e11=0/0,this.i2e12=0/0,this.i2e20=0/0,this.i2e21=0/0,this.i2e22=0/0,this.ax1=0/0,this.ay1=0/0,this.az1=0/0,this.ax2=0/0,this.ay2=0/0,this.az2=0/0,this.ax3=0/0,this.ay3=0/0,this.az3=0/0,this.r1x=0/0,this.r1y=0/0,this.r1z=0/0,this.r2x=0/0,this.r2y=0/0,this.r2z=0/0,this.t1x1=0/0,this.t1y1=0/0,this.t1z1=0/0,this.t2x1=0/0,this.t2y1=0/0,this.t2z1=0/0,this.l1x1=0/0,this.l1y1=0/0,this.l1z1=0/0,this.l2x1=0/0,this.l2y1=0/0,this.l2z1=0/0,this.a1x1=0/0,this.a1y1=0/0,this.a1z1=0/0,this.a2x1=0/0,this.a2y1=0/0,this.a2z1=0/0,this.t1x2=0/0,this.t1y2=0/0,this.t1z2=0/0,this.t2x2=0/0,this.t2y2=0/0,this.t2z2=0/0,this.l1x2=0/0,this.l1y2=0/0,this.l1z2=0/0,this.l2x2=0/0,this.l2y2=0/0,this.l2z2=0/0,this.a1x2=0/0,this.a1y2=0/0,this.a1z2=0/0,this.a2x2=0/0,this.a2y2=0/0,this.a2z2=0/0,this.t1x3=0/0,this.t1y3=0/0,this.t1z3=0/0,this.t2x3=0/0,this.t2y3=0/0,this.t2z3=0/0,this.l1x3=0/0,this.l1y3=0/0,this.l1z3=0/0,this.l2x3=0/0,this.l2y3=0/0,this.l2z3=0/0,this.a1x3=0/0,this.a1y3=0/0,this.a1z3=0/0,this.a2x3=0/0,this.a2y3=0/0,this.a2z3=0/0,this.lowerLimit1=0/0,this.upperLimit1=0/0,this.limitVelocity1=0/0,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=0/0,this.maxMotorForce1=0/0,this.maxMotorImpulse1=0/0,this.lowerLimit2=0/0,this.upperLimit2=0/0,this.limitVelocity2=0/0,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=0/0,this.maxMotorForce2=0/0,this.maxMotorImpulse2=0/0,this.lowerLimit3=0/0,this.upperLimit3=0/0,this.limitVelocity3=0/0,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=0/0,this.maxMotorForce3=0/0,this.maxMotorImpulse3=0/0,this.k00=0/0,this.k01=0/0,this.k02=0/0,this.k10=0/0,this.k11=0/0,this.k12=0/0,this.k20=0/0,this.k21=0/0,this.k22=0/0,this.kv00=0/0,this.kv11=0/0,this.kv22=0/0,this.dv00=0/0,this.dv11=0/0,this.dv22=0/0,this.d00=0/0,this.d01=0/0,this.d02=0/0,this.d10=0/0,this.d11=0/0,this.d12=0/0,this.d20=0/0,this.d21=0/0,this.d22=0/0,this.limitMotor1=t,this.limitMotor2=s,this.limitMotor3=h,this.b1=i.body1,this.b2=i.body2,this.p1=i.anchorPoint1,this.p2=i.anchorPoint2,this.r1=i.relativeAnchorPoint1,this.r2=i.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0,this.cfm1=0,this.cfm2=0,this.cfm3=0,this.weight=-1},OIMO.Translational3Constraint.prototype={constructor:OIMO.Translational3Constraint,preSolve:function(i,t){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,a=this.p2.y-this.p1.y,o=this.p2.z-this.p1.z,n=e*this.ax1+a*this.ay1+o*this.az1,l=e*this.ax2+a*this.ay2+o*this.az2,r=e*this.ax3+a*this.ay3+o*this.az3,m=this.limitMotor1.frequency,c=this.limitMotor2.frequency,x=this.limitMotor3.frequency,p=m>0,u=c>0,y=x>0,d=this.lowerLimit1<=this.upperLimit1,O=this.lowerLimit2<=this.upperLimit2,M=this.lowerLimit3<=this.upperLimit3;(p&&n>20||-20>n)&&(p=!1),(u&&l>20||-20>l)&&(u=!1),(y&&r>20||-20>r)&&(y=!1),d?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,p||(n=this.lowerLimit1)):n<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,p||(n=this.lowerLimit1)):n>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-n,p||(n=this.upperLimit1)):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),p||(this.limitVelocity1>.005?this.limitVelocity1-=.005:this.limitVelocity1<-.005?this.limitVelocity1+=.005:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0),O?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-l,u||(l=this.lowerLimit2)):l<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-l,u||(l=this.lowerLimit2)):l>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-l,u||(l=this.upperLimit2)):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),u||(this.limitVelocity2>.005?this.limitVelocity2-=.005:this.limitVelocity2<-.005?this.limitVelocity2+=.005:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0),M?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-r,y||(r=this.lowerLimit3)):r<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-r,y||(r=this.lowerLimit3)):r>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-r,y||(r=this.upperLimit3)):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),y||(this.limitVelocity3>.005?this.limitVelocity3-=.005:this.limitVelocity3<-.005?this.limitVelocity3+=.005:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||p)?this.maxMotorImpulse1=this.maxMotorForce1*i:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||u)?this.maxMotorImpulse2=this.maxMotorForce2*i:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||y)?this.maxMotorImpulse3=this.maxMotorForce3*i:(this.motorImpulse3=0,this.maxMotorImpulse3=0);var I=n*this.ax1+l*this.ax2+r*this.ax2,v=n*this.ay1+l*this.ay2+r*this.ay2,z=n*this.az1+l*this.az2+r*this.az2,f=this.m2/(this.m1+this.m2);this.weight>=0&&(f=this.weight);var b=1-f;this.r1x=this.r1.x+I*f,this.r1y=this.r1.y+v*f,this.r1z=this.r1.z+z*f,this.r2x=this.r2.x-I*b,this.r2y=this.r2.y-v*b,this.r2z=this.r2.z-z*b,this.t1x1=this.r1y*this.az1-this.r1z*this.ay1,this.t1y1=this.r1z*this.ax1-this.r1x*this.az1,this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1,this.t2x1=this.r2y*this.az1-this.r2z*this.ay1,this.t2y1=this.r2z*this.ax1-this.r2x*this.az1,this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1,this.l1x1=this.ax1*this.m1,this.l1y1=this.ay1*this.m1,this.l1z1=this.az1*this.m1,this.l2x1=this.ax1*this.m2,this.l2y1=this.ay1*this.m2,this.l2z1=this.az1*this.m2,this.a1x1=this.t1x1*this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02,this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12,this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22,this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02,this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12,this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22,this.t1x2=this.r1y*this.az2-this.r1z*this.ay2,this.t1y2=this.r1z*this.ax2-this.r1x*this.az2,this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2,this.t2x2=this.r2y*this.az2-this.r2z*this.ay2,this.t2y2=this.r2z*this.ax2-this.r2x*this.az2,this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2,this.l1x2=this.ax2*this.m1,this.l1y2=this.ay2*this.m1,this.l1z2=this.az2*this.m1,this.l2x2=this.ax2*this.m2,this.l2y2=this.ay2*this.m2,this.l2z2=this.az2*this.m2,this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02,this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12,this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22,this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02,this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12,this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22,this.t1x3=this.r1y*this.az3-this.r1z*this.ay3,this.t1y3=this.r1z*this.ax3-this.r1x*this.az3,this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3,this.t2x3=this.r2y*this.az3-this.r2z*this.ay3,this.t2y3=this.r2z*this.ax3-this.r2x*this.az3,this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3,this.l1x3=this.ax3*this.m1,this.l1y3=this.ay3*this.m1,this.l1z3=this.az3*this.m1,this.l2x3=this.ax3*this.m2,this.l2y3=this.ay3*this.m2,this.l2z3=this.az3*this.m2,this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02,this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12,this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22,this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*this.i2e02,this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12,this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;var A=this.m1+this.m2;if(this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*A,this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*A,this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*A,this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*A,this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*A,this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*A,this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*A,this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*A,this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*A,this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1,this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2,this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3,this.k10+=this.t1x2*this.a1x1+this.t1y2*this.a1y1+this.t1z2*this.a1z1,this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2,this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3,this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1,this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2,this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3,this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1,this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+this.t2z1*this.a2z2,this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3,this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1,this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2,this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3,this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1,this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2,this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3,this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,p&&2!=this.limitState1){var k=6.2831853*m,g=k*k*i,S=t/(g+2*this.limitMotor1.dampingRatio*k);this.cfm1=this.kv00*S,this.limitVelocity1*=g*S}else this.cfm1=0,this.limitVelocity1*=.05*t;u&&2!=this.limitState2?(k=6.2831853*c,g=k*k*i,S=t/(g+2*this.limitMotor2.dampingRatio*k),this.cfm2=this.kv11*S,this.limitVelocity2*=g*S):(this.cfm2=0,this.limitVelocity2*=.05*t),y&&2!=this.limitState3?(k=6.2831853*x,g=k*k*i,S=t/(g+2*this.limitMotor3.dampingRatio*k),this.cfm3=this.kv22*S,this.limitVelocity3*=g*S):(this.cfm3=0,this.limitVelocity3*=.05*t),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;
var w=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*w,this.d01=(this.k02*this.k21-this.k01*this.k22)*w,this.d02=(this.k01*this.k12-this.k02*this.k11)*w,this.d10=(this.k12*this.k20-this.k10*this.k22)*w,this.d11=(this.k00*this.k22-this.k02*this.k20)*w,this.d12=(this.k02*this.k10-this.k00*this.k12)*w,this.d20=(this.k10*this.k21-this.k11*this.k20)*w,this.d21=(this.k01*this.k20-this.k00*this.k21)*w,this.d22=(this.k00*this.k11-this.k01*this.k10)*w;var L=this.limitImpulse1+this.motorImpulse1,P=this.limitImpulse2+this.motorImpulse2,V=this.limitImpulse3+this.motorImpulse3;this.l1.x+=L*this.l1x1+P*this.l1x2+V*this.l1x3,this.l1.y+=L*this.l1y1+P*this.l1y2+V*this.l1y3,this.l1.z+=L*this.l1z1+P*this.l1z2+V*this.l1z3,this.a1.x+=L*this.a1x1+P*this.a1x2+V*this.a1x3,this.a1.y+=L*this.a1y1+P*this.a1y2+V*this.a1y3,this.a1.z+=L*this.a1z1+P*this.a1z2+V*this.a1z3,this.l2.x-=L*this.l2x1+P*this.l2x2+V*this.l2x3,this.l2.y-=L*this.l2y1+P*this.l2y2+V*this.l2y3,this.l2.z-=L*this.l2z1+P*this.l2z2+V*this.l2z3,this.a2.x-=L*this.a2x1+P*this.a2x2+V*this.a2x3,this.a2.y-=L*this.a2y1+P*this.a2y2+V*this.a2y3,this.a2.z-=L*this.a2z1+P*this.a2z2+V*this.a2z3},solve:function(){var i=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,t=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,s=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,h=i*this.ax1+t*this.ay1+s*this.az1,e=i*this.ax2+t*this.ay2+s*this.az2,a=i*this.ax3+t*this.ay3+s*this.az3,o=this.motorImpulse1,n=this.motorImpulse2,l=this.motorImpulse3,r=0,m=0,c=0;this.enableMotor1&&(r=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=r,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),r=this.motorImpulse1-o),this.enableMotor2&&(m=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=m,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),m=this.motorImpulse2-n),this.enableMotor3&&(c=(a-this.motorSpeed3)*this.dv22,this.motorImpulse3+=c,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),c=this.motorImpulse3-l),h+=r*this.kv00+m*this.k01+c*this.k02,e+=r*this.k10+m*this.kv11+c*this.k12,a+=r*this.k20+m*this.k21+c*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,a-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var x=this.limitImpulse1,p=this.limitImpulse2,u=this.limitImpulse3,y=h*this.d00+e*this.d01+a*this.d02,d=h*this.d10+e*this.d11+a*this.d12,O=h*this.d20+e*this.d21+a*this.d22;this.limitImpulse1+=y,this.limitImpulse2+=d,this.limitImpulse3+=O;var M=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(y=-x,e+=y*this.k10,a+=y*this.k20,M|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(d=-p,h+=d*this.k01,a+=d*this.k21,M|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(O=-u,h+=O*this.k02,e+=O*this.k12,M|=4);var I;switch(M){case 1:I=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*a)*I,O=(-this.k21*e+this.k11*a)*I;break;case 2:I=1/(this.k00*this.k22-this.k02*this.k20),y=(this.k22*h+-this.k02*a)*I,O=(-this.k20*h+this.k00*a)*I;break;case 3:O=a/this.k22;break;case 4:I=1/(this.k00*this.k11-this.k01*this.k10),y=(this.k11*h+-this.k01*e)*I,d=(-this.k10*h+this.k00*e)*I;break;case 5:d=e/this.k11;break;case 6:y=h/this.k00}this.limitImpulse1=x+y,this.limitImpulse2=p+d,this.limitImpulse3=u+O;var v=r+y,z=m+d,f=c+O;this.l1.x+=v*this.l1x1+z*this.l1x2+f*this.l1x3,this.l1.y+=v*this.l1y1+z*this.l1y2+f*this.l1y3,this.l1.z+=v*this.l1z1+z*this.l1z2+f*this.l1z3,this.a1.x+=v*this.a1x1+z*this.a1x2+f*this.a1x3,this.a1.y+=v*this.a1y1+z*this.a1y2+f*this.a1y3,this.a1.z+=v*this.a1z1+z*this.a1z2+f*this.a1z3,this.l2.x-=v*this.l2x1+z*this.l2x2+f*this.l2x3,this.l2.y-=v*this.l2y1+z*this.l2y2+f*this.l2y3,this.l2.z-=v*this.l2z1+z*this.l2z2+f*this.l2z3,this.a2.x-=v*this.a2x1+z*this.a2x2+f*this.a2x3,this.a2.y-=v*this.a2y1+z*this.a2y2+f*this.a2y3,this.a2.z-=v*this.a2z1+z*this.a2z2+f*this.a2z3}},OIMO.TranslationalConstraint=function(i,t){this.cfm=0/0,this.m1=0/0,this.m2=0/0,this.i1e00=0/0,this.i1e01=0/0,this.i1e02=0/0,this.i1e10=0/0,this.i1e11=0/0,this.i1e12=0/0,this.i1e20=0/0,this.i1e21=0/0,this.i1e22=0/0,this.i2e00=0/0,this.i2e01=0/0,this.i2e02=0/0,this.i2e10=0/0,this.i2e11=0/0,this.i2e12=0/0,this.i2e20=0/0,this.i2e21=0/0,this.i2e22=0/0,this.motorDenom=0/0,this.invMotorDenom=0/0,this.invDenom=0/0,this.ax=0/0,this.ay=0/0,this.az=0/0,this.r1x=0/0,this.r1y=0/0,this.r1z=0/0,this.r2x=0/0,this.r2y=0/0,this.r2z=0/0,this.t1x=0/0,this.t1y=0/0,this.t1z=0/0,this.t2x=0/0,this.t2y=0/0,this.t2z=0/0,this.l1x=0/0,this.l1y=0/0,this.l1z=0/0,this.l2x=0/0,this.l2y=0/0,this.l2z=0/0,this.a1x=0/0,this.a1y=0/0,this.a1z=0/0,this.a2x=0/0,this.a2y=0/0,this.a2z=0/0,this.lowerLimit=0/0,this.upperLimit=0/0,this.limitVelocity=0/0,this.limitState=0,this.enableMotor=!1,this.motorSpeed=0/0,this.maxMotorForce=0/0,this.maxMotorImpulse=0/0,this.limitMotor=t,this.b1=i.body1,this.b2=i.body2,this.p1=i.anchorPoint1,this.p2=i.anchorPoint2,this.r1=i.relativeAnchorPoint1,this.r2=i.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0},OIMO.TranslationalConstraint.prototype={constructor:OIMO.TranslationalConstraint,preSolve:function(i,t){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,a=this.p2.y-this.p1.y,o=this.p2.z-this.p1.z,n=e*this.ax+a*this.ay+o*this.az,l=this.limitMotor.frequency,r=l>0,m=this.lowerLimit<=this.upperLimit;(r&&n>20||-20>n)&&(r=!1),m?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,r||(n=this.lowerLimit)):n<this.lowerLimit?(-1!=this.limitState&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,r||(n=this.lowerLimit)):n>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-n,r||(n=this.upperLimit)):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),r||(this.limitVelocity>.005?this.limitVelocity-=.005:this.limitVelocity<-.005?this.limitVelocity+=.005:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||r)?this.maxMotorImpulse=this.maxMotorForce*i:(this.motorImpulse=0,this.maxMotorImpulse=0);var c=n*this.ax,x=n*this.ay,p=n*this.az,u=this.m1/(this.m1+this.m2),y=1-u;if(this.r1x=this.r1.x+c*u,this.r1y=this.r1.y+x*u,this.r1z=this.r1.z+p*u,this.r2x=this.r2.x-c*y,this.r2y=this.r2.y-x*y,this.r2z=this.r2.z-p*y,this.t1x=this.r1y*this.az-this.r1z*this.ay,this.t1y=this.r1z*this.ax-this.r1x*this.az,this.t1z=this.r1x*this.ay-this.r1y*this.ax,this.t2x=this.r2y*this.az-this.r2z*this.ay,this.t2y=this.r2z*this.ax-this.r2x*this.az,this.t2z=this.r2x*this.ay-this.r2y*this.ax,this.l1x=this.ax*this.m1,this.l1y=this.ay*this.m1,this.l1z=this.az*this.m1,this.l2x=this.ax*this.m2,this.l2y=this.ay*this.m2,this.l2z=this.az*this.m2,this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02,this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12,this.a1z=this.t1x*this.i1e20+this.t1y*this.i1e21+this.t1z*this.i1e22,this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02,this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12,this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22,this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-this.a2y*this.r2x),this.invMotorDenom=1/this.motorDenom,r&&2!=this.limitState){var d=6.2831853*l,O=d*d*i,M=t/(O+2*this.limitMotor.dampingRatio*d);this.cfm=this.motorDenom*M,this.limitVelocity*=O*M}else this.cfm=0,this.limitVelocity*=.05*t;this.invDenom=1/(this.motorDenom+this.cfm);var I=this.limitImpulse+this.motorImpulse;this.l1.x+=I*this.l1x,this.l1.y+=I*this.l1y,this.l1.z+=I*this.l1z,this.a1.x+=I*this.a1x,this.a1.y+=I*this.a1y,this.a1.z+=I*this.a1z,this.l2.x-=I*this.l2x,this.l2.y-=I*this.l2y,this.l2.z-=I*this.l2z,this.a2.x-=I*this.a2x,this.a2.y-=I*this.a2y,this.a2.z-=I*this.a2z},solve:function(){var i,t=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z;if(this.enableMotor){i=(t-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=i,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),i=this.motorImpulse-s,t-=i*this.motorDenom}else i=0;var h;if(2!=this.limitState){h=(t-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var a=h+i;this.l1.x+=a*this.l1x,this.l1.y+=a*this.l1y,this.l1.z+=a*this.l1z,this.a1.x+=a*this.a1x,this.a1.y+=a*this.a1y,this.a1.z+=a*this.a1z,this.l2.x-=a*this.l2x,this.l2.y-=a*this.l2y,this.l2.z-=a*this.l2z,this.a2.x-=a*this.a2x,this.a2.y-=a*this.a2y,this.a2.z-=a*this.a2z}},OIMO.Contact=function(){this.shape1=null,this.shape2=null,this.body1=null,this.body2=null,this.prev=null,this.next=null,this.persisting=!1,this.sleeping=!1,this.detector=null,this.constraint=null,this.touching=!1,this.b1Link=new OIMO.ContactLink(this),this.b2Link=new OIMO.ContactLink(this),this.s1Link=new OIMO.ContactLink(this),this.s2Link=new OIMO.ContactLink(this),this.manifold=new OIMO.ContactManifold,this.buffer=[],this.buffer.length=4,this.buffer[0]=new OIMO.ImpulseDataBuffer,this.buffer[1]=new OIMO.ImpulseDataBuffer,this.buffer[2]=new OIMO.ImpulseDataBuffer,this.buffer[3]=new OIMO.ImpulseDataBuffer,this.points=this.manifold.points,this.constraint=new OIMO.ContactConstraint(this.manifold)},OIMO.Contact.prototype={constructor:OIMO.Contact,mixRestitution:function(i,t){return Math.sqrt(i*t)},mixFriction:function(i,t){return Math.sqrt(i*t)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution),this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var i=this.manifold.numPoints,t=i;t--;){var s=this.buffer[t],h=this.points[t];s.lp1X=h.localPoint1.x,s.lp1Y=h.localPoint1.y,s.lp1Z=h.localPoint1.z,s.lp2X=h.localPoint2.x,s.lp2Y=h.localPoint2.y,s.lp2Z=h.localPoint2.z,s.impulse=h.normalImpulse}this.manifold.numPoints=0,this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var e=this.manifold.numPoints;if(0==e)return void(this.touching=!1);for(this.touching=!0,t=e;t--;){h=this.points[t];for(var a=h.localPoint1.x,o=h.localPoint1.y,n=h.localPoint1.z,l=h.localPoint2.x,r=h.localPoint2.y,m=h.localPoint2.z,c=-1,x=4e-4,p=i;p--;){s=this.buffer[p];var u=s.lp1X-a,y=s.lp1Y-o,d=s.lp1Z-n,O=u*u+y*y+d*d;u=s.lp2X-l,y=s.lp2Y-r,d=s.lp2Z-m;var M=u*u+y*y+d*d;M>O?x>O&&(x=O,c=p):x>M&&(x=M,c=p)}if(-1!=c){var I=this.buffer[c];this.buffer[c]=this.buffer[--i],this.buffer[i]=I,h.normalImpulse=I.impulse,h.warmStarted=!0}else h.normalImpulse=0,h.warmStarted=!1}},attach:function(i,t){this.shape1=i,this.shape2=t,this.body1=i.parent,this.body2=t.parent,this.manifold.body1=this.body1,this.manifold.body2=this.body2,this.constraint.body1=this.body1,this.constraint.body2=this.body2,this.constraint.attach(),this.s1Link.shape=t,this.s1Link.body=this.body2,this.s2Link.shape=i,this.s2Link.body=this.body1,null!=i.contactLink?(this.s1Link.next=i.contactLink).prev=this.s1Link:this.s1Link.next=null,i.contactLink=this.s1Link,i.numContacts++,null!=t.contactLink?(this.s2Link.next=t.contactLink).prev=this.s2Link:this.s2Link.next=null,t.contactLink=this.s2Link,t.numContacts++,this.b1Link.shape=t,this.b1Link.body=this.body2,this.b2Link.shape=i,this.b2Link.body=this.body1,null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:this.b1Link.next=null,this.body1.contactLink=this.b1Link,this.body1.numContacts++,null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null,this.body2.contactLink=this.b2Link,this.body2.numContacts++,this.prev=null,this.next=null,this.persisting=!0,this.sleeping=this.body1.sleeping&&this.body2.sleeping,this.manifold.numPoints=0},detach:function(){var i=this.s1Link.prev,t=this.s1Link.next;null!==i&&(i.next=t),null!==t&&(t.prev=i),this.shape1.contactLink==this.s1Link&&(this.shape1.contactLink=t),this.s1Link.prev=null,this.s1Link.next=null,this.s1Link.shape=null,this.s1Link.body=null,this.shape1.numContacts--,i=this.s2Link.prev,t=this.s2Link.next,null!==i&&(i.next=t),null!==t&&(t.prev=i),this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=t),this.s2Link.prev=null,this.s2Link.next=null,this.s2Link.shape=null,this.s2Link.body=null,this.shape2.numContacts--,i=this.b1Link.prev,t=this.b1Link.next,null!==i&&(i.next=t),null!==t&&(t.prev=i),this.body1.contactLink==this.b1Link&&(this.body1.contactLink=t),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.shape=null,this.b1Link.body=null,this.body1.numContacts--,i=this.b2Link.prev,t=this.b2Link.next,null!==i&&(i.next=t),null!==t&&(t.prev=i),this.body2.contactLink==this.b2Link&&(this.body2.contactLink=t),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.shape=null,this.b2Link.body=null,this.body2.numContacts--,this.manifold.body1=null,this.manifold.body2=null,this.constraint.body1=null,this.constraint.body2=null,this.constraint.detach(),this.shape1=null,this.shape2=null,this.body1=null,this.body2=null}},OIMO.ContactConstraint=function(i){OIMO.Constraint.call(this),this.manifold=i,this.restitution=0/0,this.friction=0/0,this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null,this.i1e00=0/0,this.i1e01=0/0,this.i1e02=0/0,this.i1e10=0/0,this.i1e11=0/0,this.i1e12=0/0,this.i1e20=0/0,this.i1e21=0/0,this.i1e22=0/0,this.i2e00=0/0,this.i2e01=0/0,this.i2e02=0/0,this.i2e10=0/0,this.i2e11=0/0,this.i2e12=0/0,this.i2e20=0/0,this.i2e21=0/0,this.i2e22=0/0,this.m1=0/0,this.m2=0/0,this.num=0,this.ps=i.points,this.cs=new OIMO.ContactPointDataBuffer,this.cs.next=new OIMO.ContactPointDataBuffer,this.cs.next.next=new OIMO.ContactPointDataBuffer,this.cs.next.next.next=new OIMO.ContactPointDataBuffer},OIMO.ContactConstraint.prototype=Object.create(OIMO.Constraint.prototype),OIMO.ContactConstraint.prototype.attach=function(){this.p1=this.body1.position,this.p2=this.body2.position,this.lv1=this.body1.linearVelocity,this.av1=this.body1.angularVelocity,this.lv2=this.body2.linearVelocity,this.av2=this.body2.angularVelocity,this.i1=this.body1.inverseInertia,this.i2=this.body2.inverseInertia},OIMO.ContactConstraint.prototype.detach=function(){this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null},OIMO.ContactConstraint.prototype.preSolve=function(i,t){this.m1=this.body1.inverseMass,this.m2=this.body2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p1.x,a=this.p1.y,o=this.p1.z,n=this.p2.x,l=this.p2.y,r=this.p2.z,m=this.m1+this.m2;this.num=this.manifold.numPoints;for(var c=this.cs,x=0;x<this.num;x++){var p,u,y,d,O,M,I=this.ps[x];p=I.position.x,u=I.position.y,y=I.position.z;var v=p-e,z=u-a,f=y-o,b=p-n,A=u-l,k=y-r;c.rp1X=v,c.rp1Y=z,c.rp1Z=f,c.rp2X=b,c.rp2Y=A,c.rp2Z=k,c.norImp=I.normalImpulse,c.tanImp=I.tangentImpulse,c.binImp=I.binormalImpulse;var g=I.normal.x,S=I.normal.y,w=I.normal.z,L=this.lv2.x+this.av2.y*k-this.av2.z*A-(this.lv1.x+this.av1.y*f-this.av1.z*z),P=this.lv2.y+this.av2.z*b-this.av2.x*k-(this.lv1.y+this.av1.z*v-this.av1.x*f),V=this.lv2.z+this.av2.x*A-this.av2.y*b-(this.lv1.z+this.av1.x*z-this.av1.y*v),T=g*L+S*P+w*V,Y=L-T*g,X=P-T*S,C=V-T*w,Z=Y*Y+X*X+C*C;Z>.04?Z=1/Math.sqrt(Z):(Y=S*g-w*w,X=-w*S-g*g,C=g*w+S*S,Z=1/Math.sqrt(Y*Y+X*X+C*C)),Y*=Z,X*=Z,C*=Z;var D=S*C-w*X,_=w*Y-g*C,B=g*X-S*Y;c.norX=g,c.norY=S,c.norZ=w,c.tanX=Y,c.tanY=X,c.tanZ=C,c.binX=D,c.binY=_,c.binZ=B,c.norU1X=g*this.m1,c.norU1Y=S*this.m1,c.norU1Z=w*this.m1,c.norU2X=g*this.m2,c.norU2Y=S*this.m2,c.norU2Z=w*this.m2,c.tanU1X=Y*this.m1,c.tanU1Y=X*this.m1,c.tanU1Z=C*this.m1,c.tanU2X=Y*this.m2,c.tanU2Y=X*this.m2,c.tanU2Z=C*this.m2,c.binU1X=D*this.m1,c.binU1Y=_*this.m1,c.binU1Z=B*this.m1,c.binU2X=D*this.m2,c.binU2Y=_*this.m2,c.binU2Z=B*this.m2;var E=z*w-f*S,R=f*g-v*w,U=v*S-z*g,j=A*w-k*S,J=k*g-b*w,F=b*S-A*g,q=z*C-f*X,N=f*Y-v*C,Q=v*X-z*Y,W=A*C-k*X,H=k*Y-b*C,G=b*X-A*Y,K=z*B-f*_,$=f*D-v*B,it=v*_-z*D,tt=A*B-k*_,st=k*D-b*B,ht=b*_-A*D,et=E*this.i1e00+R*this.i1e01+U*this.i1e02,at=E*this.i1e10+R*this.i1e11+U*this.i1e12,ot=E*this.i1e20+R*this.i1e21+U*this.i1e22,nt=j*this.i2e00+J*this.i2e01+F*this.i2e02,lt=j*this.i2e10+J*this.i2e11+F*this.i2e12,rt=j*this.i2e20+J*this.i2e21+F*this.i2e22,mt=q*this.i1e00+N*this.i1e01+Q*this.i1e02,ct=q*this.i1e10+N*this.i1e11+Q*this.i1e12,xt=q*this.i1e20+N*this.i1e21+Q*this.i1e22,pt=W*this.i2e00+H*this.i2e01+G*this.i2e02,ut=W*this.i2e10+H*this.i2e11+G*this.i2e12,yt=W*this.i2e20+H*this.i2e21+G*this.i2e22,dt=K*this.i1e00+$*this.i1e01+it*this.i1e02,Ot=K*this.i1e10+$*this.i1e11+it*this.i1e12,Mt=K*this.i1e20+$*this.i1e21+it*this.i1e22,It=tt*this.i2e00+st*this.i2e01+ht*this.i2e02,vt=tt*this.i2e10+st*this.i2e11+ht*this.i2e12,zt=tt*this.i2e20+st*this.i2e21+ht*this.i2e22;c.norT1X=E,c.norT1Y=R,c.norT1Z=U,c.tanT1X=q,c.tanT1Y=N,c.tanT1Z=Q,c.binT1X=K,c.binT1Y=$,c.binT1Z=it,c.norT2X=j,c.norT2Y=J,c.norT2Z=F,c.tanT2X=W,c.tanT2Y=H,c.tanT2Z=G,c.binT2X=tt,c.binT2Y=st,c.binT2Z=ht,c.norTU1X=et,c.norTU1Y=at,c.norTU1Z=ot,c.tanTU1X=mt,c.tanTU1Y=ct,c.tanTU1Z=xt,c.binTU1X=dt,c.binTU1Y=Ot,c.binTU1Z=Mt,c.norTU2X=nt,c.norTU2Y=lt,c.norTU2Z=rt,c.tanTU2X=pt,c.tanTU2Y=ut,c.tanTU2Z=yt,c.binTU2X=It,c.binTU2Y=vt,c.binTU2Z=zt,p=E*this.i1e00+R*this.i1e01+U*this.i1e02,u=E*this.i1e10+R*this.i1e11+U*this.i1e12,y=E*this.i1e20+R*this.i1e21+U*this.i1e22,d=u*f-y*z,O=y*v-p*f,M=p*z-u*v,p=j*this.i2e00+J*this.i2e01+F*this.i2e02,u=j*this.i2e10+J*this.i2e11+F*this.i2e12,y=j*this.i2e20+J*this.i2e21+F*this.i2e22,d+=u*k-y*A,O+=y*b-p*k,M+=p*A-u*b;var ft=1/(m+g*d+S*O+w*M);p=q*this.i1e00+N*this.i1e01+Q*this.i1e02,u=q*this.i1e10+N*this.i1e11+Q*this.i1e12,y=q*this.i1e20+N*this.i1e21+Q*this.i1e22,d=u*f-y*z,O=y*v-p*f,M=p*z-u*v,p=W*this.i2e00+H*this.i2e01+G*this.i2e02,u=W*this.i2e10+H*this.i2e11+G*this.i2e12,y=W*this.i2e20+H*this.i2e21+G*this.i2e22,d+=u*k-y*A,O+=y*b-p*k,M+=p*A-u*b;var bt=1/(m+Y*d+X*O+C*M);p=K*this.i1e00+$*this.i1e01+it*this.i1e02,u=K*this.i1e10+$*this.i1e11+it*this.i1e12,y=K*this.i1e20+$*this.i1e21+it*this.i1e22,d=u*f-y*z,O=y*v-p*f,M=p*z-u*v,p=tt*this.i2e00+st*this.i2e01+ht*this.i2e02,u=tt*this.i2e10+st*this.i2e11+ht*this.i2e12,y=tt*this.i2e20+st*this.i2e21+ht*this.i2e22,d+=u*k-y*A,O+=y*b-p*k,M+=p*A-u*b;var At=1/(m+D*d+_*O+B*M);if(c.norDen=ft,c.tanDen=bt,c.binDen=At,I.warmStarted){var kt=I.normalImpulse;this.lv1.x+=c.norU1X*kt,this.lv1.y+=c.norU1Y*kt,this.lv1.z+=c.norU1Z*kt,this.av1.x+=et*kt,this.av1.y+=at*kt,this.av1.z+=ot*kt,this.lv2.x-=c.norU2X*kt,this.lv2.y-=c.norU2Y*kt,this.lv2.z-=c.norU2Z*kt,this.av2.x-=nt*kt,this.av2.y-=lt*kt,this.av2.z-=rt*kt,c.norImp=kt,c.tanImp=0,c.binImp=0,T=0}else c.norImp=0,c.tanImp=0,c.binImp=0;T>-1&&(T=0);var gt=this.restitution*-T,St=-(I.penetration+.005)*t*.05;St>gt&&(gt=St),c.norTar=gt,c.last=x==this.num-1,c=c.next}},OIMO.ContactConstraint.prototype.solve=function(){for(var i=this.lv1.x,t=this.lv1.y,s=this.lv1.z,h=this.lv2.x,e=this.lv2.y,a=this.lv2.z,o=this.av1.x,n=this.av1.y,l=this.av1.z,r=this.av2.x,m=this.av2.y,c=this.av2.z,x=this.cs;;){var p,u,y,d,O,M=x.norImp,I=x.tanImp,v=x.binImp,z=-M*this.friction,f=h-i,b=e-t,A=a-s;O=f*x.tanX+b*x.tanY+A*x.tanZ+r*x.tanT2X+m*x.tanT2Y+c*x.tanT2Z-o*x.tanT1X-n*x.tanT1Y-l*x.tanT1Z,p=I,u=O*x.tanDen,I+=u,O=f*x.binX+b*x.binY+A*x.binZ+r*x.binT2X+m*x.binT2Y+c*x.binT2Z-o*x.binT1X-n*x.binT1Y-l*x.binT1Z,y=v,d=O*x.binDen,v+=d;var k=I*I+v*v;if(k>z*z&&(k=z/Math.sqrt(k),I*=k,v*=k),u=I-p,d=v-y,i+=x.tanU1X*u+x.binU1X*d,t+=x.tanU1Y*u+x.binU1Y*d,s+=x.tanU1Z*u+x.binU1Z*d,o+=x.tanTU1X*u+x.binTU1X*d,n+=x.tanTU1Y*u+x.binTU1Y*d,l+=x.tanTU1Z*u+x.binTU1Z*d,h-=x.tanU2X*u+x.binU2X*d,e-=x.tanU2Y*u+x.binU2Y*d,a-=x.tanU2Z*u+x.binU2Z*d,r-=x.tanTU2X*u+x.binTU2X*d,m-=x.tanTU2Y*u+x.binTU2Y*d,c-=x.tanTU2Z*u+x.binTU2Z*d,O=(h-i)*x.norX+(e-t)*x.norY+(a-s)*x.norZ+r*x.norT2X+m*x.norT2Y+c*x.norT2Z-o*x.norT1X-n*x.norT1Y-l*x.norT1Z,p=M,u=(O-x.norTar)*x.norDen,M+=u,M>0&&(M=0),u=M-p,i+=x.norU1X*u,t+=x.norU1Y*u,s+=x.norU1Z*u,o+=x.norTU1X*u,n+=x.norTU1Y*u,l+=x.norTU1Z*u,h-=x.norU2X*u,e-=x.norU2Y*u,a-=x.norU2Z*u,r-=x.norTU2X*u,m-=x.norTU2Y*u,c-=x.norTU2Z*u,x.norImp=M,x.tanImp=I,x.binImp=v,x.last)break;x=x.next}this.lv1.x=i,this.lv1.y=t,this.lv1.z=s,this.lv2.x=h,this.lv2.y=e,this.lv2.z=a,this.av1.x=o,this.av1.y=n,this.av1.z=l,this.av2.x=r,this.av2.y=m,this.av2.z=c},OIMO.ContactConstraint.prototype.postSolve=function(){for(var i=this.cs,t=this.num;t--;){var s=this.ps[t];s.normal.x=i.norX,s.normal.y=i.norY,s.normal.z=i.norZ,s.tangent.x=i.tanX,s.tangent.y=i.tanY,s.tangent.z=i.tanZ,s.binormal.x=i.binX,s.binormal.y=i.binY,s.binormal.z=i.binZ,s.normalImpulse=i.norImp,s.tangentImpulse=i.tanImp,s.binormalImpulse=i.binImp,s.normalDenominator=i.norDen,s.tangentDenominator=i.tanDen,s.binormalDenominator=i.binDen,i=i.next}},OIMO.ContactLink=function(i){this.prev=null,this.next=null,this.shape=null,this.body=null,this.contact=i},OIMO.ContactManifold=function(){this.body1=null,this.body2=null,this.numPoints=0,this.points=[],this.points.length=4,this.points[0]=new OIMO.ManifoldPoint,this.points[1]=new OIMO.ManifoldPoint,this.points[2]=new OIMO.ManifoldPoint,this.points[3]=new OIMO.ManifoldPoint},OIMO.ContactManifold.prototype={constructor:OIMO.ContactManifold,reset:function(i,t){this.body1=i.parent,this.body2=t.parent,this.numPoints=0},addPoint:function(i,t,s,h,e,a,o,n){var l=this.points[this.numPoints++];l.position.x=i,l.position.y=t,l.position.z=s;var r=this.body1.rotation,m=i-this.body1.position.x,c=t-this.body1.position.y,x=s-this.body1.position.z,p=r.elements;l.localPoint1.x=m*p[0]+c*p[3]+x*p[6],l.localPoint1.y=m*p[1]+c*p[4]+x*p[7],l.localPoint1.z=m*p[2]+c*p[5]+x*p[8],r=this.body2.rotation,m=i-this.body2.position.x,c=t-this.body2.position.y,x=s-this.body2.position.z,l.localPoint2.x=m*p[0]+c*p[3]+x*p[6],l.localPoint2.y=m*p[1]+c*p[4]+x*p[7],l.localPoint2.z=m*p[2]+c*p[5]+x*p[8],l.normalImpulse=0,n?(l.normal.x=-h,l.normal.y=-e,l.normal.z=-a):(l.normal.x=h,l.normal.y=e,l.normal.z=a),l.penetration=o,l.warmStarted=!1}},OIMO.ContactPointDataBuffer=function(){this.norX=0/0,this.norY=0/0,this.norZ=0/0,this.tanX=0/0,this.tanY=0/0,this.tanZ=0/0,this.binX=0/0,this.binY=0/0,this.binZ=0/0,this.rp1X=0/0,this.rp1Y=0/0,this.rp1Z=0/0,this.rp2X=0/0,this.rp2Y=0/0,this.rp2Z=0/0,this.norU1X=0/0,this.norU1Y=0/0,this.norU1Z=0/0,this.norU2X=0/0,this.norU2Y=0/0,this.norU2Z=0/0,this.tanU1X=0/0,this.tanU1Y=0/0,this.tanU1Z=0/0,this.tanU2X=0/0,this.tanU2Y=0/0,this.tanU2Z=0/0,this.binU1X=0/0,this.binU1Y=0/0,this.binU1Z=0/0,this.binU2X=0/0,this.binU2Y=0/0,this.binU2Z=0/0,this.norT1X=0/0,this.norT1Y=0/0,this.norT1Z=0/0,this.norT2X=0/0,this.norT2Y=0/0,this.norT2Z=0/0,this.tanT1X=0/0,this.tanT1Y=0/0,this.tanT1Z=0/0,this.tanT2X=0/0,this.tanT2Y=0/0,this.tanT2Z=0/0,this.binT1X=0/0,this.binT1Y=0/0,this.binT1Z=0/0,this.binT2X=0/0,this.binT2Y=0/0,this.binT2Z=0/0,this.norTU1X=0/0,this.norTU1Y=0/0,this.norTU1Z=0/0,this.norTU2X=0/0,this.norTU2Y=0/0,this.norTU2Z=0/0,this.tanTU1X=0/0,this.tanTU1Y=0/0,this.tanTU1Z=0/0,this.tanTU2X=0/0,this.tanTU2Y=0/0,this.tanTU2Z=0/0,this.binTU1X=0/0,this.binTU1Y=0/0,this.binTU1Z=0/0,this.binTU2X=0/0,this.binTU2Y=0/0,this.binTU2Z=0/0,this.norImp=0/0,this.tanImp=0/0,this.binImp=0/0,this.norDen=0/0,this.tanDen=0/0,this.binDen=0/0,this.norTar=0/0,this.next=null,this.last=!1},OIMO.ImpulseDataBuffer=function(){this.lp1X=0/0,this.lp1Y=0/0,this.lp1Z=0/0,this.lp2X=0/0,this.lp2Y=0/0,this.lp2Z=0/0,this.impulse=0/0},OIMO.ManifoldPoint=function(){this.warmStarted=!1,this.position=new OIMO.Vec3,this.localPoint1=new OIMO.Vec3,this.localPoint2=new OIMO.Vec3,this.normal=new OIMO.Vec3,this.tangent=new OIMO.Vec3,this.binormal=new OIMO.Vec3,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0,this.normalDenominator=0,this.tangentDenominator=0,this.binormalDenominator=0,this.penetration=0},OIMO.MassInfo=function(){this.mass=0,this.inertia=new OIMO.Mat33},OIMO.Shape=function(i){this.id=OIMO.nextID++,this.prev=null,this.next=null,this.type=0,this.proxy=null,this.parent=null,this.contactLink=null,this.numContacts=0,this.position=new OIMO.Vec3,this.rotation=new OIMO.Mat33,this.relativePosition=(new OIMO.Vec3).copy(i.relativePosition),this.relativeRotation=(new OIMO.Mat33).copy(i.relativeRotation),this.aabb=new OIMO.AABB,this.density=i.density,this.friction=i.friction,this.restitution=i.restitution,this.belongsTo=i.belongsTo,this.collidesWith=i.collidesWith},OIMO.Shape.prototype={constructor:OIMO.Shape,calculateMassInfo:function(){throw new Error("Inheritance error.")},updateProxy:function(){throw new Error("Inheritance error.")}},OIMO.ShapeConfig=function(){this.relativePosition=new OIMO.Vec3,this.relativeRotation=new OIMO.Mat33,this.friction=.4,this.restitution=.2,this.density=1,this.belongsTo=1,this.collidesWith=4294967295},OIMO.BoxShape=function(i,t,s,h){OIMO.Shape.call(this,i),this.width=t,this.height=s,this.depth=h,this.halfWidth=.5*t,this.halfHeight=.5*s,this.halfDepth=.5*h,this.dimentions=new OIMO_ARRAY_TYPE(18),this.elements=new OIMO_ARRAY_TYPE(24),this.type=OIMO.SHAPE_BOX},OIMO.BoxShape.prototype=Object.create(OIMO.Shape.prototype),OIMO.BoxShape.prototype.calculateMassInfo=function(i){var t=this.width*this.height*this.depth*this.density;i.mass=t,i.inertia.init(t*(this.height*this.height+this.depth*this.depth)/12,0,0,0,t*(this.width*this.width+this.depth*this.depth)/12,0,0,0,t*(this.width*this.width+this.height*this.height)/12)},OIMO.BoxShape.prototype.updateProxy=function(){var i=this.rotation.elements,t=this.dimentions;t[0]=i[0],t[1]=i[3],t[2]=i[6],t[3]=i[1],t[4]=i[4],t[5]=i[7],t[6]=i[2],t[7]=i[5],t[8]=i[8],t[9]=i[0]*this.halfWidth,t[10]=i[3]*this.halfWidth,t[11]=i[6]*this.halfWidth,t[12]=i[1]*this.halfHeight,t[13]=i[4]*this.halfHeight,t[14]=i[7]*this.halfHeight,t[15]=i[2]*this.halfDepth,t[16]=i[5]*this.halfDepth,t[17]=i[8]*this.halfDepth;var s=t[9],h=t[10],e=t[11],a=t[12],o=t[13],n=t[14],l=t[15],r=t[16],m=t[17],c=this.position.x,x=this.position.y,p=this.position.z,u=this.elements;u[0]=c+s+a+l,u[1]=x+h+o+r,u[2]=p+e+n+m,u[3]=c+s+a-l,u[4]=x+h+o-r,u[5]=p+e+n-m,u[6]=c+s-a+l,u[7]=x+h-o+r,u[8]=p+e-n+m,u[9]=c+s-a-l,u[10]=x+h-o-r,u[11]=p+e-n-m,u[12]=c-s+a+l,u[13]=x-h+o+r,u[14]=p-e+n+m,u[15]=c-s+a-l,u[16]=x-h+o-r,u[17]=p-e+n-m,u[18]=c-s-a+l,u[19]=x-h-o+r,u[20]=p-e-n+m,u[21]=c-s-a-l,u[22]=x-h-o-r,u[23]=p-e-n-m;var y=t[9]<0?-t[9]:t[9],d=t[10]<0?-t[10]:t[10],O=t[11]<0?-t[11]:t[11];y=t[12]<0?y-t[12]:y+t[12],d=t[13]<0?d-t[13]:d+t[13],O=t[14]<0?O-t[14]:O+t[14],y=t[15]<0?y-t[15]:y+t[15],d=t[16]<0?d-t[16]:d+t[16],O=t[17]<0?O-t[17]:O+t[17],this.aabb.init(this.position.x-y-.005,this.position.x+y+.005,this.position.y-d-.005,this.position.y+d+.005,this.position.z-O-.005,this.position.z+O+.005),null!==this.proxy&&this.proxy.update()},OIMO.SphereShape=function(i,t){OIMO.Shape.call(this,i),this.radius=t,this.type=OIMO.SHAPE_SPHERE},OIMO.SphereShape.prototype=Object.create(OIMO.Shape.prototype),OIMO.SphereShape.prototype.calculateMassInfo=function(i){var t=4/3*Math.PI*this.radius*this.radius*this.radius*this.density;i.mass=t;var s=t*this.radius*this.radius*2/5;i.inertia.init(s,0,0,0,s,0,0,0,s)},OIMO.SphereShape.prototype.updateProxy=function(){this.aabb.init(this.position.x-this.radius-.005,this.position.x+this.radius+.005,this.position.y-this.radius-.005,this.position.y+this.radius+.005,this.position.z-this.radius-.005,this.position.z+this.radius+.005),null!==this.proxy&&this.proxy.update()},OIMO.CollisionDetector=function(){this.flip=!1},OIMO.CollisionDetector.prototype={constructor:OIMO.CollisionDetector,detectCollision:function(){throw new Error("Inheritance error.")}},OIMO.BoxBoxCollisionDetector=function(){OIMO.CollisionDetector.call(this),this.clipVertices1=new OIMO_ARRAY_TYPE(24),this.clipVertices2=new OIMO_ARRAY_TYPE(24),this.used=new OIMO_ARRAY_TYPE(8),this.INF=1/0},OIMO.BoxBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.BoxBoxCollisionDetector.prototype.detectCollision=function(i,t,s){var h,e;i.id<t.id?(h=i,e=t):(h=t,e=i);var a,o,n,l,r,m,c,x,p,u,y,d,O,M,I,v,z,f,b,A,k,g,S,w,L,P,V,T,Y,X,C,Z,D,_,B,E,R=h.elements,U=e.elements,j=h.dimentions,J=e.dimentions,F=h.position,q=e.position,N=F.x,Q=F.y,W=F.z,H=q.x,G=q.y,K=q.z,$=H-N,it=G-Q,tt=K-W,st=h.halfWidth,ht=h.halfHeight,et=h.halfDepth,at=e.halfWidth,ot=e.halfHeight,nt=e.halfDepth,lt=j[0],rt=j[1],mt=j[2],ct=j[3],xt=j[4],pt=j[5],ut=j[6],yt=j[7],dt=j[8],Ot=j[9],Mt=j[10],It=j[11],vt=j[12],zt=j[13],ft=j[14],bt=j[15],At=j[16],kt=j[17],gt=J[0],St=J[1],wt=J[2],Lt=J[3],Pt=J[4],Vt=J[5],Tt=J[6],Yt=J[7],Xt=J[8],Ct=J[9],Zt=J[10],Dt=J[11],_t=J[12],Bt=J[13],Et=J[14],Rt=J[15],Ut=J[16],jt=J[17],Jt=rt*wt-mt*St,Ft=mt*gt-lt*wt,qt=lt*St-rt*gt,Nt=rt*Vt-mt*Pt,Qt=mt*Lt-lt*Vt,Wt=lt*Pt-rt*Lt,Ht=rt*Xt-mt*Yt,Gt=mt*Tt-lt*Xt,Kt=lt*Yt-rt*Tt,$t=xt*wt-pt*St,is=pt*gt-ct*wt,ts=ct*St-xt*gt,ss=xt*Vt-pt*Pt,hs=pt*Lt-ct*Vt,es=ct*Pt-xt*Lt,as=xt*Xt-pt*Yt,os=pt*Tt-ct*Xt,ns=ct*Yt-xt*Tt,ls=yt*wt-dt*St,rs=dt*gt-ut*wt,ms=ut*St-yt*gt,cs=yt*Vt-dt*Pt,xs=dt*Lt-ut*Vt,ps=ut*Pt-yt*Lt,us=yt*Xt-dt*Yt,ys=dt*Tt-ut*Xt,ds=ut*Yt-yt*Tt,Os=!1,Ms=!1,Is=!1,vs=!1,zs=!1,fs=!1,bs=!1,As=!1,ks=!1;if(C=lt*$+rt*it+mt*tt,a=C>0,a||(C=-C),Z=st,_=lt*gt+rt*St+mt*wt,B=lt*Lt+rt*Pt+mt*Vt,E=lt*Tt+rt*Yt+mt*Xt,0>_&&(_=-_),0>B&&(B=-B),0>E&&(E=-E),D=_*at+B*ot+E*nt,v=C-Z-D,!(v>0||(C=ct*$+xt*it+pt*tt,o=C>0,o||(C=-C),Z=ht,_=ct*gt+xt*St+pt*wt,B=ct*Lt+xt*Pt+pt*Vt,E=ct*Tt+xt*Yt+pt*Xt,0>_&&(_=-_),0>B&&(B=-B),0>E&&(E=-E),D=_*at+B*ot+E*nt,z=C-Z-D,z>0||(C=ut*$+yt*it+dt*tt,n=C>0,n||(C=-C),Z=et,_=ut*gt+yt*St+dt*wt,B=ut*Lt+yt*Pt+dt*Vt,E=ut*Tt+yt*Yt+dt*Xt,0>_&&(_=-_),0>B&&(B=-B),0>E&&(E=-E),D=_*at+B*ot+E*nt,f=C-Z-D,f>0||(C=gt*$+St*it+wt*tt,l=C>0,l||(C=-C),_=gt*lt+St*rt+wt*mt,B=gt*ct+St*xt+wt*pt,E=gt*ut+St*yt+wt*dt,0>_&&(_=-_),0>B&&(B=-B),0>E&&(E=-E),Z=_*st+B*ht+E*et,D=at,b=1*(C-Z-D),b>0||(C=Lt*$+Pt*it+Vt*tt,r=C>0,r||(C=-C),_=Lt*lt+Pt*rt+Vt*mt,B=Lt*ct+Pt*xt+Vt*pt,E=Lt*ut+Pt*yt+Vt*dt,0>_&&(_=-_),0>B&&(B=-B),0>E&&(E=-E),Z=_*st+B*ht+E*et,D=ot,A=1*(C-Z-D),A>0||(C=Tt*$+Yt*it+Xt*tt,m=C>0,m||(C=-C),_=Tt*lt+Yt*rt+Xt*mt,B=Tt*ct+Yt*xt+Xt*pt,E=Tt*ut+Yt*yt+Xt*dt,0>_&&(_=-_),0>B&&(B=-B),0>E&&(E=-E),Z=_*st+B*ht+E*et,D=nt,k=1*(C-Z-D),k>0))))))){if(C=Jt*Jt+Ft*Ft+qt*qt,C>1e-5){if(C=1/Math.sqrt(C),Jt*=C,Ft*=C,qt*=C,C=Jt*$+Ft*it+qt*tt,c=C>0,c||(C=-C),_=Jt*ct+Ft*xt+qt*pt,B=Jt*ut+Ft*yt+qt*dt,0>_&&(_=-_),0>B&&(B=-B),Z=_*ht+B*et,_=Jt*Lt+Ft*Pt+qt*Vt,B=Jt*Tt+Ft*Yt+qt*Xt,0>_&&(_=-_),0>B&&(B=-B),D=_*ot+B*nt,g=C-Z-D,g>0)return
}else c=!1,g=0,Os=!0;if(C=Nt*Nt+Qt*Qt+Wt*Wt,C>1e-5){if(C=1/Math.sqrt(C),Nt*=C,Qt*=C,Wt*=C,C=Nt*$+Qt*it+Wt*tt,x=C>0,x||(C=-C),_=Nt*ct+Qt*xt+Wt*pt,B=Nt*ut+Qt*yt+Wt*dt,0>_&&(_=-_),0>B&&(B=-B),Z=_*ht+B*et,_=Nt*gt+Qt*St+Wt*wt,B=Nt*Tt+Qt*Yt+Wt*Xt,0>_&&(_=-_),0>B&&(B=-B),D=_*at+B*nt,S=C-Z-D,S>0)return}else x=!1,S=0,Ms=!0;if(C=Ht*Ht+Gt*Gt+Kt*Kt,C>1e-5){if(C=1/Math.sqrt(C),Ht*=C,Gt*=C,Kt*=C,C=Ht*$+Gt*it+Kt*tt,p=C>0,p||(C=-C),_=Ht*ct+Gt*xt+Kt*pt,B=Ht*ut+Gt*yt+Kt*dt,0>_&&(_=-_),0>B&&(B=-B),Z=_*ht+B*et,_=Ht*gt+Gt*St+Kt*wt,B=Ht*Lt+Gt*Pt+Kt*Vt,0>_&&(_=-_),0>B&&(B=-B),D=_*at+B*ot,w=C-Z-D,w>0)return}else p=!1,w=0,Is=!0;if(C=$t*$t+is*is+ts*ts,C>1e-5){if(C=1/Math.sqrt(C),$t*=C,is*=C,ts*=C,C=$t*$+is*it+ts*tt,u=C>0,u||(C=-C),_=$t*lt+is*rt+ts*mt,B=$t*ut+is*yt+ts*dt,0>_&&(_=-_),0>B&&(B=-B),Z=_*st+B*et,_=$t*Lt+is*Pt+ts*Vt,B=$t*Tt+is*Yt+ts*Xt,0>_&&(_=-_),0>B&&(B=-B),D=_*ot+B*nt,L=C-Z-D,L>0)return}else u=!1,L=0,vs=!0;if(C=ss*ss+hs*hs+es*es,C>1e-5){if(C=1/Math.sqrt(C),ss*=C,hs*=C,es*=C,C=ss*$+hs*it+es*tt,y=C>0,y||(C=-C),_=ss*lt+hs*rt+es*mt,B=ss*ut+hs*yt+es*dt,0>_&&(_=-_),0>B&&(B=-B),Z=_*st+B*et,_=ss*gt+hs*St+es*wt,B=ss*Tt+hs*Yt+es*Xt,0>_&&(_=-_),0>B&&(B=-B),D=_*at+B*nt,P=C-Z-D,P>0)return}else y=!1,P=0,zs=!0;if(C=as*as+os*os+ns*ns,C>1e-5){if(C=1/Math.sqrt(C),as*=C,os*=C,ns*=C,C=as*$+os*it+ns*tt,d=C>0,d||(C=-C),_=as*lt+os*rt+ns*mt,B=as*ut+os*yt+ns*dt,0>_&&(_=-_),0>B&&(B=-B),Z=_*st+B*et,_=as*gt+os*St+ns*wt,B=as*Lt+os*Pt+ns*Vt,0>_&&(_=-_),0>B&&(B=-B),D=_*at+B*ot,V=C-Z-D,V>0)return}else d=!1,V=0,fs=!0;if(C=ls*ls+rs*rs+ms*ms,C>1e-5){if(C=1/Math.sqrt(C),ls*=C,rs*=C,ms*=C,C=ls*$+rs*it+ms*tt,O=C>0,O||(C=-C),_=ls*lt+rs*rt+ms*mt,B=ls*ct+rs*xt+ms*pt,0>_&&(_=-_),0>B&&(B=-B),Z=_*st+B*ht,_=ls*Lt+rs*Pt+ms*Vt,B=ls*Tt+rs*Yt+ms*Xt,0>_&&(_=-_),0>B&&(B=-B),D=_*ot+B*nt,T=C-Z-D,T>0)return}else O=!1,T=0,bs=!0;if(C=cs*cs+xs*xs+ps*ps,C>1e-5){if(C=1/Math.sqrt(C),cs*=C,xs*=C,ps*=C,C=cs*$+xs*it+ps*tt,M=C>0,M||(C=-C),_=cs*lt+xs*rt+ps*mt,B=cs*ct+xs*xt+ps*pt,0>_&&(_=-_),0>B&&(B=-B),Z=_*st+B*ht,_=cs*gt+xs*St+ps*wt,B=cs*Tt+xs*Yt+ps*Xt,0>_&&(_=-_),0>B&&(B=-B),D=_*at+B*nt,Y=C-Z-D,Y>0)return}else M=!1,Y=0,As=!0;if(C=us*us+ys*ys+ds*ds,C>1e-5){if(C=1/Math.sqrt(C),us*=C,ys*=C,ds*=C,C=us*$+ys*it+ds*tt,I=C>0,I||(C=-C),_=us*lt+ys*rt+ds*mt,B=us*ct+ys*xt+ds*pt,0>_&&(_=-_),0>B&&(B=-B),Z=_*st+B*ht,_=us*gt+ys*St+ds*wt,B=us*Lt+ys*Pt+ds*Vt,0>_&&(_=-_),0>B&&(B=-B),D=_*at+B*ot,X=C-Z-D,X>0)return}else I=!1,X=0,ks=!0;var gs=v,Ss=v,ws=0,Ls=a;z>Ss&&(gs=z,Ss=z,ws=1,Ls=o),f>Ss&&(gs=f,Ss=f,ws=2,Ls=n),b>Ss&&(gs=b,Ss=b,ws=3,Ls=l),A>Ss&&(gs=A,Ss=A,ws=4,Ls=r),k>Ss&&(gs=k,Ss=k,ws=5,Ls=m),g-.01>Ss&&!Os&&(gs=g,Ss=g-.01,ws=6,Ls=c),S-.01>Ss&&!Ms&&(gs=S,Ss=S-.01,ws=7,Ls=x),w-.01>Ss&&!Is&&(gs=w,Ss=w-.01,ws=8,Ls=p),L-.01>Ss&&!vs&&(gs=L,Ss=L-.01,ws=9,Ls=u),P-.01>Ss&&!zs&&(gs=P,Ss=P-.01,ws=10,Ls=y),V-.01>Ss&&!fs&&(gs=V,Ss=V-.01,ws=11,Ls=d),T-.01>Ss&&!bs&&(gs=T,Ss=T-.01,ws=12,Ls=O),Y-.01>Ss&&!As&&(gs=Y,Ss=Y-.01,ws=13,Ls=M),X-.01>Ss&&!ks&&(gs=X,ws=14,Ls=I);var Ps=0,Vs=0,Ts=0,Ys=0,Xs=0,Cs=0,Zs=0,Ds=0,_s=0,Bs=0,Es=0,Rs=0,Us=0,js=0,Js=0,Fs=0,qs=0,Ns=0,Qs=!1;0==ws?(Ls?(Bs=N+Ot,Es=Q+Mt,Rs=W+It,Ps=lt,Vs=rt,Ts=mt):(Bs=N-Ot,Es=Q-Mt,Rs=W-It,Ps=-lt,Vs=-rt,Ts=-mt),Us=vt,js=zt,Js=ft,Ys=-ct,Xs=-xt,Cs=-pt,Fs=bt,qs=At,Ns=kt,Zs=-ut,Ds=-yt,_s=-dt):1==ws?(Ls?(Bs=N+vt,Es=Q+zt,Rs=W+ft,Ps=ct,Vs=xt,Ts=pt):(Bs=N-vt,Es=Q-zt,Rs=W-ft,Ps=-ct,Vs=-xt,Ts=-pt),Us=Ot,js=Mt,Js=It,Ys=-lt,Xs=-rt,Cs=-mt,Fs=bt,qs=At,Ns=kt,Zs=-ut,Ds=-yt,_s=-dt):2==ws?(Ls?(Bs=N+bt,Es=Q+At,Rs=W+kt,Ps=ut,Vs=yt,Ts=dt):(Bs=N-bt,Es=Q-At,Rs=W-kt,Ps=-ut,Vs=-yt,Ts=-dt),Us=Ot,js=Mt,Js=It,Ys=-lt,Xs=-rt,Cs=-mt,Fs=vt,qs=zt,Ns=ft,Zs=-ct,Ds=-xt,_s=-pt):3==ws?(Qs=!0,Ls?(Bs=H-Ct,Es=G-Zt,Rs=K-Dt,Ps=-gt,Vs=-St,Ts=-wt):(Bs=H+Ct,Es=G+Zt,Rs=K+Dt,Ps=gt,Vs=St,Ts=wt),Us=_t,js=Bt,Js=Et,Ys=-Lt,Xs=-Pt,Cs=-Vt,Fs=Rt,qs=Ut,Ns=jt,Zs=-Tt,Ds=-Yt,_s=-Xt):4==ws?(Qs=!0,Ls?(Bs=H-_t,Es=G-Bt,Rs=K-Et,Ps=-Lt,Vs=-Pt,Ts=-Vt):(Bs=H+_t,Es=G+Bt,Rs=K+Et,Ps=Lt,Vs=Pt,Ts=Vt),Us=Ct,js=Zt,Js=Dt,Ys=-gt,Xs=-St,Cs=-wt,Fs=Rt,qs=Ut,Ns=jt,Zs=-Tt,Ds=-Yt,_s=-Xt):5==ws?(Qs=!0,Ls?(Bs=H-Rt,Es=G-Ut,Rs=K-jt,Ps=-Tt,Vs=-Yt,Ts=-Xt):(Bs=H+Rt,Es=G+Ut,Rs=K+jt,Ps=Tt,Vs=Yt,Ts=Xt),Us=Ct,js=Zt,Js=Dt,Ys=-gt,Xs=-St,Cs=-wt,Fs=_t,qs=Bt,Ns=Et,Zs=-Lt,Ds=-Pt,_s=-Vt):6==ws?(Ps=Jt,Vs=Ft,Ts=qt,Ys=lt,Xs=rt,Cs=mt,Zs=gt,Ds=St,_s=wt):7==ws?(Ps=Nt,Vs=Qt,Ts=Wt,Ys=lt,Xs=rt,Cs=mt,Zs=Lt,Ds=Pt,_s=Vt):8==ws?(Ps=Ht,Vs=Gt,Ts=Kt,Ys=lt,Xs=rt,Cs=mt,Zs=Tt,Ds=Yt,_s=Xt):9==ws?(Ps=$t,Vs=is,Ts=ts,Ys=ct,Xs=xt,Cs=pt,Zs=gt,Ds=St,_s=wt):10==ws?(Ps=ss,Vs=hs,Ts=es,Ys=ct,Xs=xt,Cs=pt,Zs=Lt,Ds=Pt,_s=Vt):11==ws?(Ps=as,Vs=os,Ts=ns,Ys=ct,Xs=xt,Cs=pt,Zs=Tt,Ds=Yt,_s=Xt):12==ws?(Ps=ls,Vs=rs,Ts=ms,Ys=ut,Xs=yt,Cs=dt,Zs=gt,Ds=St,_s=wt):13==ws?(Ps=cs,Vs=xs,Ts=ps,Ys=ut,Xs=yt,Cs=dt,Zs=Lt,Ds=Pt,_s=Vt):14==ws&&(Ps=us,Vs=ys,Ts=ds,Ys=ut,Xs=yt,Cs=dt,Zs=Tt,Ds=Yt,_s=Xt);if(ws>5){Ls||(Ps=-Ps,Vs=-Vs,Ts=-Ts);var Ws,Hs,Gs,Ks,$s,ih,th,sh,hh,eh,ah;ih=R[0],th=R[1],sh=R[2],Hs=Ps*ih+Vs*th+Ts*sh,Gs=R[3],Ks=R[4],$s=R[5],Ws=Ps*Gs+Vs*Ks+Ts*$s,Ws>Hs&&(Hs=Ws,ih=Gs,th=Ks,sh=$s),Gs=R[6],Ks=R[7],$s=R[8],Ws=Ps*Gs+Vs*Ks+Ts*$s,Ws>Hs&&(Hs=Ws,ih=Gs,th=Ks,sh=$s),Gs=R[9],Ks=R[10],$s=R[11],Ws=Ps*Gs+Vs*Ks+Ts*$s,Ws>Hs&&(Hs=Ws,ih=Gs,th=Ks,sh=$s),Gs=R[12],Ks=R[13],$s=R[14],Ws=Ps*Gs+Vs*Ks+Ts*$s,Ws>Hs&&(Hs=Ws,ih=Gs,th=Ks,sh=$s),Gs=R[15],Ks=R[16],$s=R[17],Ws=Ps*Gs+Vs*Ks+Ts*$s,Ws>Hs&&(Hs=Ws,ih=Gs,th=Ks,sh=$s),Gs=R[18],Ks=R[19],$s=R[20],Ws=Ps*Gs+Vs*Ks+Ts*$s,Ws>Hs&&(Hs=Ws,ih=Gs,th=Ks,sh=$s),Gs=R[21],Ks=R[22],$s=R[23],Ws=Ps*Gs+Vs*Ks+Ts*$s,Ws>Hs&&(Hs=Ws,ih=Gs,th=Ks,sh=$s),hh=U[0],eh=U[1],ah=U[2],Hs=Ps*hh+Vs*eh+Ts*ah,Gs=U[3],Ks=U[4],$s=U[5],Ws=Ps*Gs+Vs*Ks+Ts*$s,Hs>Ws&&(Hs=Ws,hh=Gs,eh=Ks,ah=$s),Gs=U[6],Ks=U[7],$s=U[8],Ws=Ps*Gs+Vs*Ks+Ts*$s,Hs>Ws&&(Hs=Ws,hh=Gs,eh=Ks,ah=$s),Gs=U[9],Ks=U[10],$s=U[11],Ws=Ps*Gs+Vs*Ks+Ts*$s,Hs>Ws&&(Hs=Ws,hh=Gs,eh=Ks,ah=$s),Gs=U[12],Ks=U[13],$s=U[14],Ws=Ps*Gs+Vs*Ks+Ts*$s,Hs>Ws&&(Hs=Ws,hh=Gs,eh=Ks,ah=$s),Gs=U[15],Ks=U[16],$s=U[17],Ws=Ps*Gs+Vs*Ks+Ts*$s,Hs>Ws&&(Hs=Ws,hh=Gs,eh=Ks,ah=$s),Gs=U[18],Ks=U[19],$s=U[20],Ws=Ps*Gs+Vs*Ks+Ts*$s,Hs>Ws&&(Hs=Ws,hh=Gs,eh=Ks,ah=$s),Gs=U[21],Ks=U[22],$s=U[23],Ws=Ps*Gs+Vs*Ks+Ts*$s,Hs>Ws&&(Hs=Ws,hh=Gs,eh=Ks,ah=$s),Gs=hh-ih,Ks=eh-th,$s=ah-sh,_=Ys*Zs+Xs*Ds+Cs*_s;var oh=(Gs*(Ys-Zs*_)+Ks*(Xs-Ds*_)+$s*(Cs-_s*_))/(1-_*_);return void s.addPoint(ih+Ys*oh+Ps*gs*.5,th+Xs*oh+Vs*gs*.5,sh+Cs*oh+Ts*gs*.5,Ps,Vs,Ts,gs,!1)}var nh,lh,rh,mh,ch,xh,ph,uh,yh,dh,Oh,Mh,Ih=1,vh=0,zh=0;Qs?(vh=lt*Ps+rt*Vs+mt*Ts,Ih>vh&&(Ih=vh,zh=0),Ih>-vh&&(Ih=-vh,zh=1),vh=ct*Ps+xt*Vs+pt*Ts,Ih>vh&&(Ih=vh,zh=2),Ih>-vh&&(Ih=-vh,zh=3),vh=ut*Ps+yt*Vs+dt*Ts,Ih>vh&&(Ih=vh,zh=4),Ih>-vh&&(Ih=-vh,zh=5),0==zh?(nh=R[0],lh=R[1],rh=R[2],mh=R[6],ch=R[7],xh=R[8],ph=R[9],uh=R[10],yh=R[11],dh=R[3],Oh=R[4],Mh=R[5]):1==zh?(nh=R[15],lh=R[16],rh=R[17],mh=R[21],ch=R[22],xh=R[23],ph=R[18],uh=R[19],yh=R[20],dh=R[12],Oh=R[13],Mh=R[14]):2==zh?(nh=R[12],lh=R[13],rh=R[14],mh=R[0],ch=R[1],xh=R[2],ph=R[3],uh=R[4],yh=R[5],dh=R[15],Oh=R[16],Mh=R[17]):3==zh?(nh=R[21],lh=R[22],rh=R[23],mh=R[9],ch=R[10],xh=R[11],ph=R[6],uh=R[7],yh=R[8],dh=R[18],Oh=R[19],Mh=R[20]):4==zh?(nh=R[12],lh=R[13],rh=R[14],mh=R[18],ch=R[19],xh=R[20],ph=R[6],uh=R[7],yh=R[8],dh=R[0],Oh=R[1],Mh=R[2]):5==zh&&(nh=R[3],lh=R[4],rh=R[5],mh=R[6],ch=R[7],xh=R[8],ph=R[21],uh=R[22],yh=R[23],dh=R[15],Oh=R[16],Mh=R[17])):(vh=gt*Ps+St*Vs+wt*Ts,Ih>vh&&(Ih=vh,zh=0),Ih>-vh&&(Ih=-vh,zh=1),vh=Lt*Ps+Pt*Vs+Vt*Ts,Ih>vh&&(Ih=vh,zh=2),Ih>-vh&&(Ih=-vh,zh=3),vh=Tt*Ps+Yt*Vs+Xt*Ts,Ih>vh&&(Ih=vh,zh=4),Ih>-vh&&(Ih=-vh,zh=5),0==zh?(nh=U[0],lh=U[1],rh=U[2],mh=U[6],ch=U[7],xh=U[8],ph=U[9],uh=U[10],yh=U[11],dh=U[3],Oh=U[4],Mh=U[5]):1==zh?(nh=U[15],lh=U[16],rh=U[17],mh=U[21],ch=U[22],xh=U[23],ph=U[18],uh=U[19],yh=U[20],dh=U[12],Oh=U[13],Mh=U[14]):2==zh?(nh=U[12],lh=U[13],rh=U[14],mh=U[0],ch=U[1],xh=U[2],ph=U[3],uh=U[4],yh=U[5],dh=U[15],Oh=U[16],Mh=U[17]):3==zh?(nh=U[21],lh=U[22],rh=U[23],mh=U[9],ch=U[10],xh=U[11],ph=U[6],uh=U[7],yh=U[8],dh=U[18],Oh=U[19],Mh=U[20]):4==zh?(nh=U[12],lh=U[13],rh=U[14],mh=U[18],ch=U[19],xh=U[20],ph=U[6],uh=U[7],yh=U[8],dh=U[0],Oh=U[1],Mh=U[2]):5==zh&&(nh=U[3],lh=U[4],rh=U[5],mh=U[9],ch=U[10],xh=U[11],ph=U[21],uh=U[22],yh=U[23],dh=U[15],Oh=U[16],Mh=U[17]));var fh,bh,Ah,kh,gh,Sh,wh,Lh,Ph;this.clipVertices1[0]=nh,this.clipVertices1[1]=lh,this.clipVertices1[2]=rh,this.clipVertices1[3]=mh,this.clipVertices1[4]=ch,this.clipVertices1[5]=xh,this.clipVertices1[6]=ph,this.clipVertices1[7]=uh,this.clipVertices1[8]=yh,this.clipVertices1[9]=dh,this.clipVertices1[10]=Oh,this.clipVertices1[11]=Mh,bh=0,kh=this.clipVertices1[9],gh=this.clipVertices1[10],Sh=this.clipVertices1[11],_=(kh-Bs-Us)*Ys+(gh-Es-js)*Xs+(Sh-Rs-Js)*Cs;for(var Vh=0;4>Vh;Vh++)Ah=3*Vh,wh=this.clipVertices1[Ah],Lh=this.clipVertices1[Ah+1],Ph=this.clipVertices1[Ah+2],B=(wh-Bs-Us)*Ys+(Lh-Es-js)*Xs+(Ph-Rs-Js)*Cs,_>0?B>0?(Ah=3*bh,bh++,this.clipVertices2[Ah]=wh,this.clipVertices2[Ah+1]=Lh,this.clipVertices2[Ah+2]=Ph):(Ah=3*bh,bh++,oh=_/(_-B),this.clipVertices2[Ah]=kh+(wh-kh)*oh,this.clipVertices2[Ah+1]=gh+(Lh-gh)*oh,this.clipVertices2[Ah+2]=Sh+(Ph-Sh)*oh):B>0&&(Ah=3*bh,bh++,oh=_/(_-B),this.clipVertices2[Ah]=kh+(wh-kh)*oh,this.clipVertices2[Ah+1]=gh+(Lh-gh)*oh,this.clipVertices2[Ah+2]=Sh+(Ph-Sh)*oh,Ah=3*bh,bh++,this.clipVertices2[Ah]=wh,this.clipVertices2[Ah+1]=Lh,this.clipVertices2[Ah+2]=Ph),kh=wh,gh=Lh,Sh=Ph,_=B;if(fh=bh,0!=fh){for(bh=0,Ah=3*(fh-1),kh=this.clipVertices2[Ah],gh=this.clipVertices2[Ah+1],Sh=this.clipVertices2[Ah+2],_=(kh-Bs-Fs)*Zs+(gh-Es-qs)*Ds+(Sh-Rs-Ns)*_s,Vh=0;fh>Vh;Vh++)Ah=3*Vh,wh=this.clipVertices2[Ah],Lh=this.clipVertices2[Ah+1],Ph=this.clipVertices2[Ah+2],B=(wh-Bs-Fs)*Zs+(Lh-Es-qs)*Ds+(Ph-Rs-Ns)*_s,_>0?B>0?(Ah=3*bh,bh++,this.clipVertices1[Ah]=wh,this.clipVertices1[Ah+1]=Lh,this.clipVertices1[Ah+2]=Ph):(Ah=3*bh,bh++,oh=_/(_-B),this.clipVertices1[Ah]=kh+(wh-kh)*oh,this.clipVertices1[Ah+1]=gh+(Lh-gh)*oh,this.clipVertices1[Ah+2]=Sh+(Ph-Sh)*oh):B>0&&(Ah=3*bh,bh++,oh=_/(_-B),this.clipVertices1[Ah]=kh+(wh-kh)*oh,this.clipVertices1[Ah+1]=gh+(Lh-gh)*oh,this.clipVertices1[Ah+2]=Sh+(Ph-Sh)*oh,Ah=3*bh,bh++,this.clipVertices1[Ah]=wh,this.clipVertices1[Ah+1]=Lh,this.clipVertices1[Ah+2]=Ph),kh=wh,gh=Lh,Sh=Ph,_=B;if(fh=bh,0!=fh){for(bh=0,Ah=3*(fh-1),kh=this.clipVertices1[Ah],gh=this.clipVertices1[Ah+1],Sh=this.clipVertices1[Ah+2],_=(kh-Bs+Us)*-Ys+(gh-Es+js)*-Xs+(Sh-Rs+Js)*-Cs,Vh=0;fh>Vh;Vh++)Ah=3*Vh,wh=this.clipVertices1[Ah],Lh=this.clipVertices1[Ah+1],Ph=this.clipVertices1[Ah+2],B=(wh-Bs+Us)*-Ys+(Lh-Es+js)*-Xs+(Ph-Rs+Js)*-Cs,_>0?B>0?(Ah=3*bh,bh++,this.clipVertices2[Ah]=wh,this.clipVertices2[Ah+1]=Lh,this.clipVertices2[Ah+2]=Ph):(Ah=3*bh,bh++,oh=_/(_-B),this.clipVertices2[Ah]=kh+(wh-kh)*oh,this.clipVertices2[Ah+1]=gh+(Lh-gh)*oh,this.clipVertices2[Ah+2]=Sh+(Ph-Sh)*oh):B>0&&(Ah=3*bh,bh++,oh=_/(_-B),this.clipVertices2[Ah]=kh+(wh-kh)*oh,this.clipVertices2[Ah+1]=gh+(Lh-gh)*oh,this.clipVertices2[Ah+2]=Sh+(Ph-Sh)*oh,Ah=3*bh,bh++,this.clipVertices2[Ah]=wh,this.clipVertices2[Ah+1]=Lh,this.clipVertices2[Ah+2]=Ph),kh=wh,gh=Lh,Sh=Ph,_=B;if(fh=bh,0!=fh){for(bh=0,Ah=3*(fh-1),kh=this.clipVertices2[Ah],gh=this.clipVertices2[Ah+1],Sh=this.clipVertices2[Ah+2],_=(kh-Bs+Fs)*-Zs+(gh-Es+qs)*-Ds+(Sh-Rs+Ns)*-_s,Vh=0;fh>Vh;Vh++)Ah=3*Vh,wh=this.clipVertices2[Ah],Lh=this.clipVertices2[Ah+1],Ph=this.clipVertices2[Ah+2],B=(wh-Bs+Fs)*-Zs+(Lh-Es+qs)*-Ds+(Ph-Rs+Ns)*-_s,_>0?B>0?(Ah=3*bh,bh++,this.clipVertices1[Ah]=wh,this.clipVertices1[Ah+1]=Lh,this.clipVertices1[Ah+2]=Ph):(Ah=3*bh,bh++,oh=_/(_-B),this.clipVertices1[Ah]=kh+(wh-kh)*oh,this.clipVertices1[Ah+1]=gh+(Lh-gh)*oh,this.clipVertices1[Ah+2]=Sh+(Ph-Sh)*oh):B>0&&(Ah=3*bh,bh++,oh=_/(_-B),this.clipVertices1[Ah]=kh+(wh-kh)*oh,this.clipVertices1[Ah+1]=gh+(Lh-gh)*oh,this.clipVertices1[Ah+2]=Sh+(Ph-Sh)*oh,Ah=3*bh,bh++,this.clipVertices1[Ah]=wh,this.clipVertices1[Ah+1]=Lh,this.clipVertices1[Ah+2]=Ph),kh=wh,gh=Lh,Sh=Ph,_=B;if(fh=bh,Qs){var Th=h;h=e,e=Th}if(0!=fh){var Yh=h!=i;if(fh>4){kh=.25*(nh+mh+ph+dh),gh=.25*(lh+ch+uh+Oh),Sh=.25*(rh+xh+yh+Mh),Ys=nh-kh,Xs=lh-gh,Cs=rh-Sh,Zs=mh-kh,Ds=ch-gh,_s=xh-Sh;var Xh=0,Ch=0,Zh=0,Dh=0,_h=-this.INF;for(Ih=this.INF,Vh=0;fh>Vh;Vh++)this.used[Vh]=!1,Ah=3*Vh,kh=this.clipVertices1[Ah],gh=this.clipVertices1[Ah+1],Sh=this.clipVertices1[Ah+2],vh=kh*Ys+gh*Xs+Sh*Cs,Ih>vh&&(Ih=vh,Xh=Vh),vh>_h&&(_h=vh,Zh=Vh);for(this.used[Xh]=!0,this.used[Zh]=!0,_h=-this.INF,Ih=this.INF,Vh=0;fh>Vh;Vh++)this.used[Vh]||(Ah=3*Vh,kh=this.clipVertices1[Ah],gh=this.clipVertices1[Ah+1],Sh=this.clipVertices1[Ah+2],vh=kh*Zs+gh*Ds+Sh*_s,Ih>vh&&(Ih=vh,Ch=Vh),vh>_h&&(_h=vh,Dh=Vh));Ah=3*Xh,kh=this.clipVertices1[Ah],gh=this.clipVertices1[Ah+1],Sh=this.clipVertices1[Ah+2],vh=(kh-Bs)*Ps+(gh-Es)*Vs+(Sh-Rs)*Ts,0>vh&&s.addPoint(kh,gh,Sh,Ps,Vs,Ts,vh,Yh),Ah=3*Ch,kh=this.clipVertices1[Ah],gh=this.clipVertices1[Ah+1],Sh=this.clipVertices1[Ah+2],vh=(kh-Bs)*Ps+(gh-Es)*Vs+(Sh-Rs)*Ts,0>vh&&s.addPoint(kh,gh,Sh,Ps,Vs,Ts,vh,Yh),Ah=3*Zh,kh=this.clipVertices1[Ah],gh=this.clipVertices1[Ah+1],Sh=this.clipVertices1[Ah+2],vh=(kh-Bs)*Ps+(gh-Es)*Vs+(Sh-Rs)*Ts,0>vh&&s.addPoint(kh,gh,Sh,Ps,Vs,Ts,vh,Yh),Ah=3*Dh,kh=this.clipVertices1[Ah],gh=this.clipVertices1[Ah+1],Sh=this.clipVertices1[Ah+2],vh=(kh-Bs)*Ps+(gh-Es)*Vs+(Sh-Rs)*Ts,0>vh&&s.addPoint(kh,gh,Sh,Ps,Vs,Ts,vh,Yh)}else for(Vh=0;fh>Vh;Vh++)Ah=3*Vh,kh=this.clipVertices1[Ah],gh=this.clipVertices1[Ah+1],Sh=this.clipVertices1[Ah+2],vh=(kh-Bs)*Ps+(gh-Es)*Vs+(Sh-Rs)*Ts,0>vh&&s.addPoint(kh,gh,Sh,Ps,Vs,Ts,vh,Yh)}}}}}},OIMO.SphereBoxCollisionDetector=function(i){OIMO.CollisionDetector.call(this),this.flip=i},OIMO.SphereBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.SphereBoxCollisionDetector.prototype.detectCollision=function(i,t,s){var h,e;this.flip?(h=t,e=i):(h=i,e=t);var a,o,n,l,r,m=e.dimentions,c=h.position,x=c.x,p=c.y,u=c.z,y=e.position,d=y.x,O=y.y,M=y.z,I=h.radius,v=e.halfWidth,z=e.halfHeight,f=e.halfDepth,b=x-d,A=p-O,k=u-M,g=m[0]*b+m[1]*A+m[2]*k,S=m[3]*b+m[4]*A+m[5]*k,w=m[6]*b+m[7]*A+m[8]*k,L=0;g>v?g=v:-v>g?g=-v:L=1,S>z?S=z:-z>S?S=-z:L|=2,w>f?w=f:-f>w?w=-f:L|=4,7==L?(b=0>g?v+g:v-g,A=0>S?z+S:z-S,k=0>w?f+w:f-w,A>b?k>b?(l=b-v,0>g?(g=-v,b=m[0],A=m[1],k=m[2]):(g=v,b=-m[0],A=-m[1],k=-m[2])):(l=k-f,0>w?(w=-f,b=m[6],A=m[7],k=m[8]):(w=f,b=-m[6],A=-m[7],k=-m[8])):k>A?(l=A-z,0>S?(S=-z,b=m[3],A=m[4],k=m[5]):(S=z,b=-m[3],A=-m[4],k=-m[5])):(l=k-f,0>w?(w=-f,b=m[6],A=m[7],k=m[8]):(w=f,b=-m[6],A=-m[7],k=-m[8])),a=d+g*m[0]+S*m[3]+w*m[6],o=O+g*m[1]+S*m[4]+w*m[7],n=M+g*m[2]+S*m[5]+w*m[8],s.addPoint(x+I*b,p+I*A,u+I*k,b,A,k,l-I,this.flip)):(a=d+g*m[0]+S*m[3]+w*m[6],o=O+g*m[1]+S*m[4]+w*m[7],n=M+g*m[2]+S*m[5]+w*m[8],b=a-c.x,A=o-c.y,k=n-c.z,l=b*b+A*A+k*k,l>0&&I*I>l&&(l=Math.sqrt(l),r=1/l,b*=r,A*=r,k*=r,s.addPoint(x+I*b,p+I*A,u+I*k,b,A,k,l-I,this.flip)))},OIMO.SphereSphereCollisionDetector=function(){OIMO.CollisionDetector.call(this)},OIMO.SphereSphereCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.SphereSphereCollisionDetector.prototype.detectCollision=function(i,t,s){var h=i,e=t,a=h.position,o=e.position,n=o.x-a.x,l=o.y-a.y,r=o.z-a.z,m=n*n+l*l+r*r,c=h.radius,x=e.radius,p=c+x;if(m>0&&p*p>m){m=Math.sqrt(m);var u=1/m;n*=u,l*=u,r*=u,s.addPoint(a.x+n*c,a.y+l*c,a.z+r*c,n,l,r,m-p,!1)}},OIMO.AABB=function(i,t,s,h,e,a){this.minX=i||0,this.maxX=t||0,this.minY=s||0,this.maxY=h||0,this.minZ=e||0,this.maxZ=a||0},OIMO.AABB.prototype={constructor:OIMO.AABB,init:function(i,t,s,h,e,a){this.minX=i,this.maxX=t,this.minY=s,this.maxY=h,this.minZ=e,this.maxZ=a},combine:function(i,t){this.minX=i.minX<t.minX?i.minX:t.minX,this.maxX=i.maxX>t.maxX?i.maxX:t.maxX,this.minY=i.minY<t.minY?i.minY:t.minY,this.maxY=i.maxY>t.maxY?i.maxY:t.maxY,this.minZ=i.minZ<t.minZ?i.minZ:t.minZ,this.maxZ=i.maxZ>t.maxZ?i.maxZ:t.maxZ},surfaceArea:function(){var i=this.maxY-this.minY,t=this.maxZ-this.minZ;return 2*((this.maxX-this.minX)*(i+t)+i*t)},intersectsWithPoint:function(i,t,s){return i>=this.minX&&i<=this.maxX&&t>=this.minY&&t<=this.maxY&&s>=this.minZ&&s<=this.maxZ}},OIMO.Proxy=function(i){this.shape=i,this.aabb=i.aabb},OIMO.Proxy.prototype={constructor:OIMO.Proxy,update:function(){throw new Error("Inheritance error.")}},OIMO.BasicProxy=function(i){OIMO.Proxy.call(this,i)},OIMO.BasicProxy.prototype=Object.create(OIMO.Proxy.prototype),OIMO.BasicProxy.prototype.update=function(){},OIMO.BroadPhase=function(){this.types=0,this.numPairChecks=0,this.numPairs=0,this.bufferSize=256,this.pairs=[],this.pairs.length=this.bufferSize;for(var i=this.bufferSize;i--;)this.pairs[i]=new OIMO.Pair},OIMO.BroadPhase.prototype={constructor:OIMO.BroadPhase,createProxy:function(){throw new Error("Inheritance error.")},addProxy:function(){throw new Error("Inheritance error.")},removeProxy:function(){throw new Error("Inheritance error.")},isAvailablePair:function(i,t){var s=i.parent,h=t.parent;if(s==h||!s.isDynamic&&!h.isDynamic||0==(i.belongsTo&t.collidesWith)||0==(t.belongsTo&i.collidesWith))return!1;var e;for(e=s.numJoints<h.numJoints?s.jointLink:h.jointLink;null!=e;){var a=e.joint;if(!a.allowCollision&&(a.body1==s&&a.body2==h||a.body1==h&&a.body2==s))return!1;e=e.next}return!0},detectPairs:function(){for(;this.numPairs>0;){var i=this.pairs[--this.numPairs];i.shape1=null,i.shape2=null}this.numPairChecks=0,this.collectPairs()},collectPairs:function(){throw new Error("Inheritance error.")},addPair:function(i,t){if(this.numPairs==this.bufferSize){var s=this.bufferSize<<1,h=[];h.length=this.bufferSize;for(var e=0,a=this.bufferSize;a>e;e++)h[e]=this.pairs[e];for(e=this.newBufferSize,e=this.bufferSize,a=s;a>e;e++)h[e]=new OIMO.Pair;this.pairs=h,this.bufferSize=s}var o=this.pairs[this.numPairs++];o.shape1=i,o.shape2=t}},OIMO.BruteForceBroadPhase=function(){OIMO.BroadPhase.call(this),this.types=1,this.numProxies=0,this.maxProxies=256,this.proxies=[],this.proxies.length=256},OIMO.BruteForceBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype),OIMO.BruteForceBroadPhase.prototype.createProxy=function(i){return new OIMO.BasicProxy(i)},OIMO.BruteForceBroadPhase.prototype.addProxy=function(i){if(this.numProxies==this.maxProxies){this.maxProxies*=2;var t=[];t.length=this.maxProxies;for(var s=this.numProxies;s--;)t[s]=this.proxies[s];this.proxies=t}this.proxies[this.numProxies++]=i},OIMO.BruteForceBroadPhase.prototype.removeProxy=function(i){for(var t=this.numProxies;t--;)if(this.proxies[t]==i)return this.proxies[t]=this.proxies[--this.numProxies],void(this.proxies[this.numProxies]=null)},OIMO.BruteForceBroadPhase.prototype.collectPairs=function(){this.numPairChecks=this.numProxies*(this.numProxies-1)>>1;for(var i=this.numProxies;i--;)for(var t=this.proxies[i],s=t.aabb,h=t.shape,e=this.numProxies;e--;)if(e!==i){var a=this.proxies[e],o=a.aabb,n=a.shape;if(s.maxX<o.minX||s.minX>o.maxX||s.maxY<o.minY||s.minY>o.maxY||s.maxZ<o.minZ||s.minZ>o.maxZ||!this.isAvailablePair(h,n))continue;this.addPair(h,n)}},OIMO.Pair=function(){this.shape1=null,this.shape2=null},OIMO.SAPAxis=function(){this.numElements=0,this.bufferSize=256,this.elements=[],this.elements.length=this.bufferSize,this.stack=new OIMO_ARRAY_TYPE(64)},OIMO.SAPAxis.prototype={constructor:OIMO.SAPAxis,addElements:function(i,t){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var s=[],h=this.numElements;h--;)s[h]=this.elements[h]}this.elements[this.numElements++]=i,this.elements[this.numElements++]=t},removeElements:function(i,t){for(var s=-1,h=-1,e=0,a=this.numElements;a>e;e++){var o=this.elements[e];if(o==i||o==t){if(-1!=s){h=e;break}s=e}}for(e=s+1,a=h;a>e;e++)this.elements[e-1]=this.elements[e];for(e=h+1,a=this.numElements;a>e;e++)this.elements[e-2]=this.elements[e];this.elements[--this.numElements]=null,this.elements[--this.numElements]=null},sort:function(){for(var i=0,t=1;this.numElements>>t!=0;)t++;t=t*this.numElements>>2,i=0;for(var s=!1,h=this.elements,e=1,a=this.numElements;a>e;e++){var o=h[e],n=o.value,l=h[e-1];if(l.value>n){var r=e;do{if(h[r]=l,0==--r)break;l=h[r-1]}while(l.value>n);if(h[r]=o,i+=e-r,i>t){s=!0;break}}}if(s){i=2;var m=this.stack;for(m[0]=0,m[1]=this.numElements-1;i>0;){var c=m[--i],x=m[--i],p=c-x;if(p>16){var u=x+Math.floor(.5*p);for(o=h[u],h[u]=h[c],h[c]=o,n=o.value,e=x-1,r=c;;){var y,d;do y=h[++e];while(y.value<n);do d=h[--r];while(n<d.value&&r!=x);if(e>=r)break;h[e]=d,h[r]=y}h[c]=h[e],h[e]=o,e-x>c-e?(m[i++]=x,m[i++]=e-1,m[i++]=e+1,m[i++]=c):(m[i++]=e+1,m[i++]=c,m[i++]=x,m[i++]=e-1)}else for(e=x+1;c>=e;e++)if(o=h[e],n=o.value,l=h[e-1],l.value>n){r=e;do{if(h[r]=l,0==--r)break;l=h[r-1]}while(l.value>n);h[r]=o}}}},calculateTestCount:function(){for(var i=1,t=0,s=1,h=this.numElements;h>s;s++)this.elements[s].max?i--:(t+=i,i++);return t}},OIMO.SAPBroadPhase=function(){OIMO.BroadPhase.call(this),this.types=2,this.numElementsD=0,this.numElementsS=0,this.axesD=[],this.axesS=[],this.axesD.length=3,this.axesS.length=3,this.axesD[0]=new OIMO.SAPAxis,this.axesD[1]=new OIMO.SAPAxis,this.axesD[2]=new OIMO.SAPAxis,this.axesS[0]=new OIMO.SAPAxis,this.axesS[1]=new OIMO.SAPAxis,this.axesS[2]=new OIMO.SAPAxis,this.index1=0,this.index2=1},OIMO.SAPBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype),OIMO.SAPBroadPhase.prototype.createProxy=function(i){return new OIMO.SAPProxy(this,i)},OIMO.SAPBroadPhase.prototype.addProxy=function(i){var t=i;t.isDynamic()?(this.axesD[0].addElements(t.min[0],t.max[0]),this.axesD[1].addElements(t.min[1],t.max[1]),this.axesD[2].addElements(t.min[2],t.max[2]),t.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(t.min[0],t.max[0]),this.axesS[1].addElements(t.min[1],t.max[1]),this.axesS[2].addElements(t.min[2],t.max[2]),t.belongsTo=2,this.numElementsS+=2)},OIMO.SAPBroadPhase.prototype.removeProxy=function(i){var t=i;if(0!=t.belongsTo){switch(t.belongsTo){case 1:this.axesD[0].removeElements(t.min[0],t.max[0]),this.axesD[1].removeElements(t.min[1],t.max[1]),this.axesD[2].removeElements(t.min[2],t.max[2]),this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(t.min[0],t.max[0]),this.axesS[1].removeElements(t.min[1],t.max[1]),this.axesS[2].removeElements(t.min[2],t.max[2]),this.numElementsS-=2}t.belongsTo=0}},OIMO.SAPBroadPhase.prototype.collectPairs=function(){if(0!=this.numElementsD){var i=this.axesD[this.index1],t=this.axesD[this.index2];i.sort(),t.sort();var s,h,e=i.calculateTestCount(),a=t.calculateTestCount();a>=e?(t=this.axesS[this.index1],t.sort(),s=i.elements,h=t.elements):(i=this.axesS[this.index2],i.sort(),s=t.elements,h=i.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var o,n,l=0,r=0;l<this.numElementsD;){var m,c;if(r==this.numElementsS)m=s[l],c=!0,l++;else{var x=s[l],p=h[r];x.value<p.value?(m=x,c=!0,l++):(m=p,c=!1,r++)}if(m.max){var u=m.pair;if(c){if(u==o){o=o.pair;continue}m=o}else{if(u==n){n=n.pair;continue}m=n}do{if(v=m.pair,v===u){m.pair=v.pair;break}m=v}while(null!==m)}else{for(var y=m.proxy.shape,d=m.min1.value,O=m.max1.value,M=m.min2.value,I=m.max2.value,v=o;null!=v;v=v.pair){var z=v.proxy.shape;this.numPairChecks++,d>v.max1.value||O<v.min1.value||M>v.max2.value||I<v.min2.value||!this.isAvailablePair(y,z)||this.addPair(y,z)}if(c){for(v=n;null!=v;v=v.pair)z=v.proxy.shape,this.numPairChecks++,d>v.max1.value||O<v.min1.value||M>v.max2.value||I<v.min2.value||!this.isAvailablePair(y,z)||this.addPair(y,z);m.pair=o,o=m}else m.pair=n,n=m}}this.index2=3^(this.index1|this.index2)}},OIMO.SAPElement=function(i,t){this.proxy=i,this.pair=null,this.min1=null,this.max1=null,this.min2=null,this.max2=null,this.max=t,this.value=0},OIMO.SAPProxy=function(i,t){OIMO.Proxy.call(this,t),this.belongsTo=0,this.max=[],this.min=[],this.sap=i,this.min[0]=new OIMO.SAPElement(this,!1),this.max[0]=new OIMO.SAPElement(this,!0),this.min[1]=new OIMO.SAPElement(this,!1),this.max[1]=new OIMO.SAPElement(this,!0),this.min[2]=new OIMO.SAPElement(this,!1),this.max[2]=new OIMO.SAPElement(this,!0),this.max[0].pair=this.min[0],this.max[1].pair=this.min[1],this.max[2].pair=this.min[2],this.min[0].min1=this.min[1],this.min[0].max1=this.max[1],this.min[0].min2=this.min[2],this.min[0].max2=this.max[2],this.min[1].min1=this.min[0],this.min[1].max1=this.max[0],this.min[1].min2=this.min[2],this.min[1].max2=this.max[2],this.min[2].min1=this.min[0],this.min[2].max1=this.max[0],this.min[2].min2=this.min[1],this.min[2].max2=this.max[1]},OIMO.SAPProxy.prototype=Object.create(OIMO.Proxy.prototype),OIMO.SAPProxy.prototype.isDynamic=function(){var i=this.shape.parent;return i.isDynamic&&!i.sleeping},OIMO.SAPProxy.prototype.update=function(){this.min[0].value=this.aabb.minX,this.max[0].value=this.aabb.maxX,this.min[1].value=this.aabb.minY,this.max[1].value=this.aabb.maxY,this.min[2].value=this.aabb.minZ,this.max[2].value=this.aabb.maxZ,(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())&&(this.sap.removeProxy(this),this.sap.addProxy(this))},OIMO.DBVT=function(){this.root=null,this.freeNodes=[],this.freeNodes.length=16384,this.numFreeNodes=0,this.aabb=new OIMO.AABB},OIMO.DBVT.prototype={constructor:OIMO.DBVT,moveLeaf:function(i){this.deleteLeaf(i),this.insertLeaf(i)},insertLeaf:function(i){if(null==this.root)return void(this.root=i);for(var t,s,h=i.aabb,e=this.root;null==e.proxy;){var a=e.child1,o=e.child2,n=e.aabb,l=a.aabb,r=o.aabb;t=n.surfaceArea(),this.aabb.combine(h,n),s=this.aabb.surfaceArea();var m=2*s,c=2*(s-t),x=c;this.aabb.combine(h,l),x+=null!=a.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-l.surfaceArea();var p=c;if(this.aabb.combine(h,r),p+=null!=o.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-r.surfaceArea(),p>x){if(x>m)break;e=a}else{if(p>m)break;e=o}}var u,y=e.parent;u=this.numFreeNodes>0?this.freeNodes[--this.numFreeNodes]:new OIMO.DBVTNode,u.parent=y,u.child1=i,u.child2=e,u.aabb.combine(i.aabb,e.aabb),u.height=e.height+1,e.parent=u,i.parent=u,e==this.root?this.root=u:y.child1==e?y.child1=u:y.child2=u;do u=this.balance(u),this.fix(u),u=u.parent;while(null!=u)},getBalance:function(i){return null!=i.proxy?0:i.child1.height-i.child2.height},print:function(i,t,s){var h=null==i.proxy;h&&(s=this.print(i.child1,t+1,s));for(var e=2*t;e>=0;e--)s+=" ";return s+=(h?this.getBalance(i):"["+i.proxy.aabb.minX+"]")+"\n",h&&(s=this.print(i.child2,t+1,s)),s},deleteLeaf:function(i){if(i==this.root)return void(this.root=null);var t,s=i.parent;if(t=s.child1==i?s.child2:s.child1,s==this.root)return this.root=t,void(t.parent=null);var h=s.parent;t.parent=h,h.child1==s?h.child1=t:h.child2=t,this.numFreeNodes<16384&&(this.freeNodes[this.numFreeNodes++]=s);do h=this.balance(h),this.fix(h),h=h.parent;while(null!=h)},balance:function(i){var t=i.height;if(2>t)return i;var s,h=i.parent,e=i.child1,a=i.child2,o=e.height,n=a.height,l=o-n;if(l>1){var r=e.child1,m=e.child2,c=r.height,x=m.height;return c>x?(e.child2=i,i.parent=e,i.child1=m,m.parent=i,i.aabb.combine(m.aabb,a.aabb),s=x-n,i.height=x-(s&s>>31)+1,e.aabb.combine(r.aabb,i.aabb),s=c-t,e.height=c-(s&s>>31)+1):(e.child1=i,i.parent=e,i.child1=r,r.parent=i,i.aabb.combine(r.aabb,a.aabb),s=c-n,i.height=c-(s&s>>31)+1,e.aabb.combine(i.aabb,m.aabb),s=t-x,e.height=t-(s&s>>31)+1),null!=h?h.child1==i?h.child1=e:h.child2=e:this.root=e,e.parent=h,e}if(-1>l){var p=a.child1,u=a.child2,y=p.height,d=u.height;return y>d?(a.child2=i,i.parent=a,i.child2=u,u.parent=i,i.aabb.combine(e.aabb,u.aabb),s=o-d,i.height=o-(s&s>>31)+1,a.aabb.combine(p.aabb,i.aabb),s=y-t,a.height=y-(s&s>>31)+1):(a.child1=i,i.parent=a,i.child2=p,p.parent=i,i.aabb.combine(e.aabb,p.aabb),s=o-y,i.height=o-(s&s>>31)+1,a.aabb.combine(i.aabb,u.aabb),s=t-d,a.height=t-(s&s>>31)+1),null!=h?h.child1==i?h.child1=a:h.child2=a:this.root=a,a.parent=h,a}return i},fix:function(i){var t=i.child1,s=i.child2;i.aabb.combine(t.aabb,s.aabb);var h=t.height,e=s.height;i.height=e>h?e+1:h+1}},OIMO.DBVTBroadPhase=function(){OIMO.BroadPhase.call(this),this.types=3,this.numLeaves=0,this.maxLeaves=0,this.tree=new OIMO.DBVT,this.maxStack=256,this.stack=[],this.stack.length=this.maxStack,this.maxLeaves=256,this.leaves=[],this.leaves.length=this.maxLeaves},OIMO.DBVTBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype),OIMO.DBVTBroadPhase.prototype.createProxy=function(i){return new OIMO.DBVTProxy(i)},OIMO.DBVTBroadPhase.prototype.addProxy=function(i){var t=i;if(this.tree.insertLeaf(t.leaf),this.numLeaves==this.maxLeaves){this.maxLeaves*=2;var s=[];s.length=this.maxLeaves;for(var h=0;h<this.numLeaves;h++)s[h]=this.leaves[h];this.leaves=s}this.leaves[this.numLeaves++]=t.leaf},OIMO.DBVTBroadPhase.prototype.removeProxy=function(i){var t=i;this.tree.deleteLeaf(t.leaf);for(var s=0;s<this.numLeaves;s++)if(this.leaves[s]==t.leaf)return this.leaves[s]=this.leaves[--this.numLeaves],void(this.leaves[this.numLeaves]=null)},OIMO.DBVTBroadPhase.prototype.collectPairs=function(){if(!(this.numLeaves<2))for(var i=0;i<this.numLeaves;i++){var t=this.leaves[i],s=t.proxy.aabb,h=t.aabb;if(s.minX<h.minX||s.maxX>h.maxX||s.minY<h.minY||s.maxY>h.maxY||s.minZ<h.minZ||s.maxZ>h.maxZ){var e=.1;this.tree.deleteLeaf(t),h.minX=s.minX-e,h.maxX=s.maxX+e,h.minY=s.minY-e,h.maxY=s.maxY+e,h.minZ=s.minZ-e,h.maxZ=s.maxZ+e,this.tree.insertLeaf(t),this.collide(t,this.tree.root)}}},OIMO.DBVTBroadPhase.prototype.collide=function(i,t){var s=2;for(this.stack[0]=i,this.stack[1]=t;s>0;){var h=this.stack[--s],e=this.stack[--s],a=null!=h.proxy,o=null!=e.proxy;if(this.numPairChecks++,a&&o){var n=h.proxy.shape,l=e.proxy.shape,r=n.aabb,m=l.aabb;if(n==l||r.maxX<m.minX||r.minX>m.maxX||r.maxY<m.minY||r.minY>m.maxY||r.maxZ<m.minZ||r.minZ>m.maxZ||!this.isAvailablePair(n,l))continue;this.addPair(n,l)}else{if(r=h.aabb,m=e.aabb,r.maxX<m.minX||r.minX>m.maxX||r.maxY<m.minY||r.minY>m.maxY||r.maxZ<m.minZ||r.minZ>m.maxZ)continue;if(s+4>=this.maxStack){this.maxStack*=2;var c=[];c.length=this.maxStack;for(var x=0;s>x;x++)c[x]=this.stack[x];this.stack=c}o||!a&&h.aabb.surfaceArea()>e.aabb.surfaceArea()?(this.stack[s++]=h.child1,this.stack[s++]=e,this.stack[s++]=h.child2,this.stack[s++]=e):(this.stack[s++]=h,this.stack[s++]=e.child1,this.stack[s++]=h,this.stack[s++]=e.child2)}}},OIMO.DBVTNode=function(){this.child1=null,this.child2=null,this.parent=null,this.proxy=null,this.height=0,this.aabb=new OIMO.AABB},OIMO.DBVTProxy=function(i){OIMO.Proxy.call(this,i),this.leaf=new OIMO.DBVTNode,this.leaf.proxy=this},OIMO.DBVTProxy.prototype=Object.create(OIMO.Proxy.prototype),OIMO.DBVTProxy.prototype.update=function(){};